<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Let’s boost the models | Boosting methods: Theory and application in R</title>
  <meta name="description" content="Boosting methods: Theory and Application in R (XGBoost)" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Let’s boost the models | Boosting methods: Theory and application in R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Boosting methods: Theory and Application in R (XGBoost)" />
  <meta name="github-repo" content="EmanuelSommer/boosting_methods" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Let’s boost the models | Boosting methods: Theory and application in R" />
  
  <meta name="twitter:description" content="Boosting methods: Theory and Application in R (XGBoost)" />
  

<meta name="author" content="Emanuel Sommer" />


<meta name="date" content="2021-06-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="eda.html"/>
<link rel="next" href="conclusion.html"/>
<script src="libs/header-attrs/header-attrs.js"></script>
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Boosting methods</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="theory.html"><a href="theory.html"><i class="fa fa-check"></i><b>3</b> Theory</a>
<ul>
<li class="chapter" data-level="3.1" data-path="theory.html"><a href="theory.html#the-powerful-idea-of-gradient-boosting"><i class="fa fa-check"></i><b>3.1</b> The powerful idea of gradient boosting</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="theory.html"><a href="theory.html#forward-stagewise-additive-modeling"><i class="fa fa-check"></i><b>3.1.1</b> Forward Stagewise Additive Modeling</a></li>
<li class="chapter" data-level="3.1.2" data-path="theory.html"><a href="theory.html#robust-loss-functions-for-regression"><i class="fa fa-check"></i><b>3.1.2</b> Robust loss functions for regression</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="theory.html"><a href="theory.html#general-gradient-tree-boosting"><i class="fa fa-check"></i><b>3.2</b> General gradient tree boosting</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="theory.html"><a href="theory.html#numOpt"><i class="fa fa-check"></i><b>3.2.1</b> Numerical optimization</a></li>
<li class="chapter" data-level="3.2.2" data-path="theory.html"><a href="theory.html#single-tree-depth"><i class="fa fa-check"></i><b>3.2.2</b> Single tree depth</a></li>
<li class="chapter" data-level="3.2.3" data-path="theory.html"><a href="theory.html#combOver"><i class="fa fa-check"></i><b>3.2.3</b> Combat overfitting</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="theory.html"><a href="theory.html#xgboost-a-highly-efficient-implementation"><i class="fa fa-check"></i><b>3.3</b> XGBoost a highly efficient implementation</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="theory.html"><a href="theory.html#regularized-loss"><i class="fa fa-check"></i><b>3.3.1</b> Regularized loss</a></li>
<li class="chapter" data-level="3.3.2" data-path="theory.html"><a href="theory.html#shrinkage-and-subsampling"><i class="fa fa-check"></i><b>3.3.2</b> Shrinkage and subsampling</a></li>
<li class="chapter" data-level="3.3.3" data-path="theory.html"><a href="theory.html#even-more-tweaks"><i class="fa fa-check"></i><b>3.3.3</b> Even more tweaks</a></li>
<li class="chapter" data-level="3.3.4" data-path="theory.html"><a href="theory.html#hyperparameters-overview"><i class="fa fa-check"></i><b>3.3.4</b> Hyperparameters overview</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="eda.html"><a href="eda.html"><i class="fa fa-check"></i><b>4</b> Explore the data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="eda.html"><a href="eda.html#burnout-data"><i class="fa fa-check"></i><b>4.1</b> Burnout data</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="eda.html"><a href="eda.html#train-test-split"><i class="fa fa-check"></i><b>4.1.1</b> Train-test split</a></li>
<li class="chapter" data-level="4.1.2" data-path="eda.html"><a href="eda.html#quick-general-overview"><i class="fa fa-check"></i><b>4.1.2</b> Quick general overview</a></li>
<li class="chapter" data-level="4.1.3" data-path="eda.html"><a href="eda.html#what-about-the-outcome-variable"><i class="fa fa-check"></i><b>4.1.3</b> What about the outcome variable?</a></li>
<li class="chapter" data-level="4.1.4" data-path="eda.html"><a href="eda.html#distribution-and-main-effects-of-the-predictors"><i class="fa fa-check"></i><b>4.1.4</b> Distribution and main effects of the predictors</a></li>
<li class="chapter" data-level="4.1.5" data-path="eda.html"><a href="eda.html#relationships-between-the-predictors"><i class="fa fa-check"></i><b>4.1.5</b> Relationships between the predictors</a></li>
<li class="chapter" data-level="4.1.6" data-path="eda.html"><a href="eda.html#some-feature-engineering"><i class="fa fa-check"></i><b>4.1.6</b> Some feature engineering</a></li>
<li class="chapter" data-level="4.1.7" data-path="eda.html"><a href="eda.html#create-the-recipe"><i class="fa fa-check"></i><b>4.1.7</b> Create the recipe</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="eda.html"><a href="eda.html#insurence-data"><i class="fa fa-check"></i><b>4.2</b> Insurence data</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="eda.html"><a href="eda.html#train-test-split-1"><i class="fa fa-check"></i><b>4.2.1</b> Train-test split</a></li>
<li class="chapter" data-level="4.2.2" data-path="eda.html"><a href="eda.html#a-general-overview"><i class="fa fa-check"></i><b>4.2.2</b> A general overview</a></li>
<li class="chapter" data-level="4.2.3" data-path="eda.html"><a href="eda.html#what-about-the-outcome"><i class="fa fa-check"></i><b>4.2.3</b> What about the outcome?</a></li>
<li class="chapter" data-level="4.2.4" data-path="eda.html"><a href="eda.html#distribution-and-main-effects-of-the-predictors-1"><i class="fa fa-check"></i><b>4.2.4</b> Distribution and main effects of the predictors</a></li>
<li class="chapter" data-level="4.2.5" data-path="eda.html"><a href="eda.html#relationships-between-the-predictors-1"><i class="fa fa-check"></i><b>4.2.5</b> Relationships between the predictors</a></li>
<li class="chapter" data-level="4.2.6" data-path="eda.html"><a href="eda.html#create-the-recipe-1"><i class="fa fa-check"></i><b>4.2.6</b> Create the recipe</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>5</b> Let’s boost the models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="modeling.html"><a href="modeling.html#burnout-data-1"><i class="fa fa-check"></i><b>5.1</b> Burnout data</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="modeling.html"><a href="modeling.html#baseline-models"><i class="fa fa-check"></i><b>5.1.1</b> Baseline models</a></li>
<li class="chapter" data-level="5.1.2" data-path="modeling.html"><a href="modeling.html#model-specification"><i class="fa fa-check"></i><b>5.1.2</b> Model specification</a></li>
<li class="chapter" data-level="5.1.3" data-path="modeling.html"><a href="modeling.html#tuning"><i class="fa fa-check"></i><b>5.1.3</b> Tuning</a></li>
<li class="chapter" data-level="5.1.4" data-path="modeling.html"><a href="modeling.html#evaluate-and-understand-the-model"><i class="fa fa-check"></i><b>5.1.4</b> Evaluate and understand the model</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="modeling.html"><a href="modeling.html#insurance-data"><i class="fa fa-check"></i><b>5.2</b> Insurance data</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="modeling.html"><a href="modeling.html#baseline-models-1"><i class="fa fa-check"></i><b>5.2.1</b> Baseline models</a></li>
<li class="chapter" data-level="5.2.2" data-path="modeling.html"><a href="modeling.html#model-specification-1"><i class="fa fa-check"></i><b>5.2.2</b> Model specification</a></li>
<li class="chapter" data-level="5.2.3" data-path="modeling.html"><a href="modeling.html#tuning-1"><i class="fa fa-check"></i><b>5.2.3</b> Tuning</a></li>
<li class="chapter" data-level="5.2.4" data-path="modeling.html"><a href="modeling.html#evaluate-and-understand-the-model-1"><i class="fa fa-check"></i><b>5.2.4</b> Evaluate and understand the model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>6</b> Conclusion</a>
<ul>
<li class="chapter" data-level="6.1" data-path="conclusion.html"><a href="conclusion.html#pros"><i class="fa fa-check"></i><b>6.1</b> Pros</a></li>
<li class="chapter" data-level="6.2" data-path="conclusion.html"><a href="conclusion.html#cons"><i class="fa fa-check"></i><b>6.2</b> Cons</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>7</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Boosting methods: Theory and application in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="modeling" class="section level1" number="5">
<h1><span class="header-section-number">Chapter 5</span> Let’s boost the models</h1>
<p>Beside the XGBoost model also a random forest model will be fitted here for comparison. The whole modeling approach and procedure is closely following the principles that are outlined in the <strong>great</strong> book <em>Tidy modeling with R</em> by Max Kuhn and Julia Silge.</p>
<p>For the modeling three additional packages are required.<span class="citation">[<a href="#ref-xgboost_package" role="doc-biblioref">5</a>, <a href="#ref-ranger_package" role="doc-biblioref">16</a>, <a href="#ref-vipPack" role="doc-biblioref">17</a>]</span></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="modeling.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost) <span class="co"># for the xgboost model</span></span>
<span id="cb42-2"><a href="modeling.html#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger) <span class="co"># for the random forest model</span></span>
<span id="cb42-3"><a href="modeling.html#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># + the vip package but it will not be loaded into</span></span>
<span id="cb42-4"><a href="modeling.html#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the namespace</span></span></code></pre></div>
<p>For parallel computations the <code>doParallel</code> package is used.<span class="citation">[<a href="#ref-doParallel_package" role="doc-biblioref">18</a>]</span>
This is most useful for the tuning part.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="modeling.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb43-2"><a href="modeling.html#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="modeling.html#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a cluster object and then register: </span></span>
<span id="cb43-4"><a href="modeling.html#cb43-4" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makePSOCKcluster</span>(<span class="dv">2</span>)</span>
<span id="cb43-5"><a href="modeling.html#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span></code></pre></div>
<p>First one has to set a <strong>metric</strong> for the evaluation of the final performance. As one knows from the EDA that not a lot of outliers are present in the data one can leave the default for XGBoost as the optimization metric for regression which is the root mean squared error (RMSE) which basically corresponds to the <span class="math inline">\(L_2\)</span> loss. Besides also the mean average error (MAE) which is kind of the <span class="math inline">\(L_1\)</span> norm will be covered but the optimization and tuning will focus on the RMSE.</p>
<div id="burnout-data-1" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Burnout data</h2>
<div id="baseline-models" class="section level3" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Baseline models</h3>
<p>The first thing is to set up the trivial <strong>baseline models</strong>.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="modeling.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the trivial intercept only model:</span></span>
<span id="cb44-2"><a href="modeling.html#cb44-2" aria-hidden="true" tabindex="-1"></a>bout_predict_trivial_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(new_data) {</span>
<span id="cb44-3"><a href="modeling.html#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rep</span>(<span class="fu">mean</span>(burnout_train<span class="sc">$</span>burn_rate), <span class="fu">nrow</span>(new_data))</span>
<span id="cb44-4"><a href="modeling.html#cb44-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-5"><a href="modeling.html#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="modeling.html#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the trivial scoring of mental fatigue score (if missing intercept model)</span></span>
<span id="cb44-7"><a href="modeling.html#cb44-7" aria-hidden="true" tabindex="-1"></a>bout_predict_trivial_mfs <span class="ot">&lt;-</span> <span class="cf">function</span>(new_data) {</span>
<span id="cb44-8"><a href="modeling.html#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># these two scoring parameters are correspondint to the </span></span>
<span id="cb44-9"><a href="modeling.html#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simple linear regression model containing only one predictor</span></span>
<span id="cb44-10"><a href="modeling.html#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i.e. mfs</span></span>
<span id="cb44-11"><a href="modeling.html#cb44-11" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> new_data[[<span class="st">&quot;mental_fatigue_score&quot;</span>]] <span class="sc">*</span> <span class="fl">0.097</span> <span class="sc">-</span> <span class="fl">0.1</span></span>
<span id="cb44-12"><a href="modeling.html#cb44-12" aria-hidden="true" tabindex="-1"></a>  pred[<span class="fu">is.na</span>(pred)] <span class="ot">&lt;-</span> <span class="fu">mean</span>(burnout_train<span class="sc">$</span>burn_rate)</span>
<span id="cb44-13"><a href="modeling.html#cb44-13" aria-hidden="true" tabindex="-1"></a>  pred</span>
<span id="cb44-14"><a href="modeling.html#cb44-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The predictions of these baseline models on the test data set will be compared with the predictions of the tree-based models that will be constructed.</p>
</div>
<div id="model-specification" class="section level3" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Model specification</h3>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="modeling.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Models:</span></span>
<span id="cb45-2"><a href="modeling.html#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="modeling.html#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Random forest model for comparison</span></span>
<span id="cb45-4"><a href="modeling.html#cb45-4" aria-hidden="true" tabindex="-1"></a>bout_rf_model <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb45-5"><a href="modeling.html#cb45-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mtry =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb45-6"><a href="modeling.html#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;ranger&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-7"><a href="modeling.html#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span>
<span id="cb45-8"><a href="modeling.html#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="modeling.html#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># XGBoost model </span></span>
<span id="cb45-10"><a href="modeling.html#cb45-10" aria-hidden="true" tabindex="-1"></a>bout_boost_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb45-11"><a href="modeling.html#cb45-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb45-12"><a href="modeling.html#cb45-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb45-13"><a href="modeling.html#cb45-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb45-14"><a href="modeling.html#cb45-14" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb45-15"><a href="modeling.html#cb45-15" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample_size =</span> <span class="fu">tune</span>(),</span>
<span id="cb45-16"><a href="modeling.html#cb45-16" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stop_iter =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-17"><a href="modeling.html#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-18"><a href="modeling.html#cb45-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="modeling.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Workflows: model + recipe</span></span>
<span id="cb46-2"><a href="modeling.html#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="modeling.html#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Random Forest workflow</span></span>
<span id="cb46-4"><a href="modeling.html#cb46-4" aria-hidden="true" tabindex="-1"></a>bout_rf_wflow <span class="ot">&lt;-</span></span>
<span id="cb46-5"><a href="modeling.html#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-6"><a href="modeling.html#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(bout_rf_model) <span class="sc">%&gt;%</span></span>
<span id="cb46-7"><a href="modeling.html#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(burnout_rec_rf)</span>
<span id="cb46-8"><a href="modeling.html#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="modeling.html#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># XGBoost workflow with the untransformed target</span></span>
<span id="cb46-10"><a href="modeling.html#cb46-10" aria-hidden="true" tabindex="-1"></a>bout_boost_wflow <span class="ot">&lt;-</span></span>
<span id="cb46-11"><a href="modeling.html#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-12"><a href="modeling.html#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(bout_boost_model) <span class="sc">%&gt;%</span></span>
<span id="cb46-13"><a href="modeling.html#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(burnout_rec_boost)</span>
<span id="cb46-14"><a href="modeling.html#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="modeling.html#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co"># XGBoost workflow with the transformed target (empirical logit)</span></span>
<span id="cb46-16"><a href="modeling.html#cb46-16" aria-hidden="true" tabindex="-1"></a>bout_boost_wflow_trans <span class="ot">&lt;-</span></span>
<span id="cb46-17"><a href="modeling.html#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-18"><a href="modeling.html#cb46-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(bout_boost_model) <span class="sc">%&gt;%</span></span>
<span id="cb46-19"><a href="modeling.html#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(burnout_rec_boost_trans)</span></code></pre></div>
</div>
<div id="tuning" class="section level3" number="5.1.3">
<h3><span class="header-section-number">5.1.3</span> Tuning</h3>
<p>For the hyperparameter tuning one needs validation sets to monitor the models on unseen data. To do this 5-fold cross validation (CV) is used here.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="modeling.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Resampling object</span></span>
<span id="cb47-2"><a href="modeling.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb47-3"><a href="modeling.html#cb47-3" aria-hidden="true" tabindex="-1"></a>burnout_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(burnout_train, <span class="at">v =</span> <span class="dv">5</span>)</span></code></pre></div>
<p>Now adjust or check the hyperparameter ranges that the tuning will use. First the Random forest model.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="modeling.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Have a look at the hyperparameters that have to be tuned and finalize them</span></span>
<span id="cb48-2"><a href="modeling.html#cb48-2" aria-hidden="true" tabindex="-1"></a>bout_rf_params <span class="ot">&lt;-</span> bout_rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="modeling.html#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>()</span>
<span id="cb48-4"><a href="modeling.html#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="modeling.html#cb48-5" aria-hidden="true" tabindex="-1"></a>bout_rf_params </span></code></pre></div>
<pre><code>## Collection of 2 parameters for tuning
## 
##  identifier  type    object
##        mtry  mtry nparam[?]
##       trees trees nparam[+]
## 
## Model parameters needing finalization:
##    # Randomly Selected Predictors (&#39;mtry&#39;)
## 
## See `?dials::finalize` or `?dials::update.parameters` for more information.</code></pre>
<p>This shows that the <code>mtry</code> hyperparameter has to be adjusted depending on the data. Moreover with the <code>dials::update</code> function one can manually set the ranges that should be used for tuning.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="modeling.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># default range for tuning is 1 up to 2000 for the trees argument</span></span>
<span id="cb50-2"><a href="modeling.html#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># set the lower bound of the range to 100. Then finalize the</span></span>
<span id="cb50-3"><a href="modeling.html#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters using the training data.</span></span>
<span id="cb50-4"><a href="modeling.html#cb50-4" aria-hidden="true" tabindex="-1"></a>bout_rf_params <span class="ot">&lt;-</span> bout_rf_params <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="modeling.html#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">trees =</span> <span class="fu">trees</span>(<span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">2000</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb50-6"><a href="modeling.html#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(burnout_train)</span>
<span id="cb50-7"><a href="modeling.html#cb50-7" aria-hidden="true" tabindex="-1"></a>bout_rf_params</span></code></pre></div>
<pre><code>## Collection of 2 parameters for tuning
## 
##  identifier  type    object
##        mtry  mtry nparam[+]
##       trees trees nparam[+]</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="modeling.html#cb52-1" aria-hidden="true" tabindex="-1"></a>bout_rf_params <span class="sc">%&gt;%</span> <span class="fu">pull_dials_object</span>(<span class="st">&quot;mtry&quot;</span>)</span></code></pre></div>
<pre><code>## # Randomly Selected Predictors (quantitative)
## Range: [1, 10]</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="modeling.html#cb54-1" aria-hidden="true" tabindex="-1"></a>bout_rf_params <span class="sc">%&gt;%</span> <span class="fu">pull_dials_object</span>(<span class="st">&quot;trees&quot;</span>)</span></code></pre></div>
<pre><code>## # Trees (quantitative)
## Range: [100, 2000]</code></pre>
<p>Now this parameter object is ready for tuning and the same steps have to be performed on the main boosting workflow. The parameter set for the untransformed target can then also be used for the transformed one.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="modeling.html#cb56-1" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb56-2"><a href="modeling.html#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>()</span>
<span id="cb56-3"><a href="modeling.html#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="modeling.html#cb56-4" aria-hidden="true" tabindex="-1"></a>bout_boost_params </span></code></pre></div>
<pre><code>## Collection of 6 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[?]
##           trees          trees nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]
## 
## Model parameters needing finalization:
##    # Randomly Selected Predictors (&#39;mtry&#39;)
## 
## See `?dials::finalize` or `?dials::update.parameters` for more information.</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="modeling.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first a look at the default ranges</span></span>
<span id="cb58-2"><a href="modeling.html#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">trees</span>()</span></code></pre></div>
<pre><code>## # Trees (quantitative)
## Range: [1, 2000]</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="modeling.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tree_depth</span>()</span></code></pre></div>
<pre><code>## Tree Depth (quantitative)
## Range: [1, 15]</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="modeling.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">learn_rate</span>()</span></code></pre></div>
<pre><code>## Learning Rate (quantitative)
## Transformer:  log-10 
## Range (transformed scale): [-10, -1]</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="modeling.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loss_reduction</span>()</span></code></pre></div>
<pre><code>## Minimum Loss Reduction (quantitative)
## Transformer:  log-10 
## Range (transformed scale): [-10, 1.5]</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="modeling.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sample_size</span>()</span></code></pre></div>
<pre><code>## # Observations Sampled (quantitative)
## Range: [?, ?]</code></pre>
<p>So <code>sample_size</code> must also be finalized. Again the lower bound on the number of trees will be raised to 100. The other scales are really sensible and will be left as is.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="modeling.html#cb68-1" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="ot">&lt;-</span> bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb68-2"><a href="modeling.html#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">trees =</span> <span class="fu">trees</span>(<span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">2000</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="modeling.html#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(burnout_train)</span>
<span id="cb68-4"><a href="modeling.html#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="modeling.html#cb68-5" aria-hidden="true" tabindex="-1"></a>bout_boost_params</span></code></pre></div>
<pre><code>## Collection of 6 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[+]
##           trees          trees nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="modeling.html#cb70-1" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb70-2"><a href="modeling.html#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull_dials_object</span>(<span class="st">&quot;sample_size&quot;</span>)</span></code></pre></div>
<pre><code>## Proportion Observations Sampled (quantitative)
## Range: [0.1, 1]</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="modeling.html#cb72-1" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb72-2"><a href="modeling.html#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull_dials_object</span>(<span class="st">&quot;mtry&quot;</span>)</span></code></pre></div>
<pre><code>## # Randomly Selected Predictors (quantitative)
## Range: [1, 10]</code></pre>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="modeling.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use the same object for the tuning of the boosted model</span></span>
<span id="cb74-2"><a href="modeling.html#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with the transformed target</span></span>
<span id="cb74-3"><a href="modeling.html#cb74-3" aria-hidden="true" tabindex="-1"></a>bout_boost_params_trans <span class="ot">&lt;-</span> bout_boost_params</span></code></pre></div>
<p>Now also these parameter objects are ready to be used. The next step is to define the metrics used for evaluation while tuning.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="modeling.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define a metrics set used for evaluation of the hyperparameters</span></span>
<span id="cb75-2"><a href="modeling.html#cb75-2" aria-hidden="true" tabindex="-1"></a>regr_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(rmse, mae)</span></code></pre></div>
<p>Now the actual tuning begins. The models will be tuned by a space filling grid search. As one has defined ranges for each parameter one can then use different algorithms to construct a grid of combinations of parameter values that tries to best fill the defined ranges by random sampling also in a high dimensional setting. In the following the function <code>tune::grid_latin_hypercube</code> is used for this. So basically one tries out all hyperparameter values for each fold and saves the performance of the performance metrics on the hold out fold. These metrics are then aggregated for each combination and with the resulting estimates of performance one can choose the final set of hyperparameters. The more hyperparameters the model has the more tuning rounds might be needed to refine the grid. Besides the classical grid search there are also iterative methods for tuning. These are mainly good to tune a single hyperparameter at once and not for a bunch of them simultaneously. They will not be used in the following.</p>
<p>The <strong>random forest model</strong> goes first with the tuning.</p>
<p>Here there are as seen above only two hyperparameters to be tuned thus 30 combinations should suffice.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="modeling.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 30 minutes</span></span>
<span id="cb76-2"><a href="modeling.html#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb76-3"><a href="modeling.html#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb76-4"><a href="modeling.html#cb76-4" aria-hidden="true" tabindex="-1"></a>  bout_rf_tune <span class="ot">&lt;-</span> bout_rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb76-5"><a href="modeling.html#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb76-6"><a href="modeling.html#cb76-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  burnout_folds,</span>
<span id="cb76-7"><a href="modeling.html#cb76-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> bout_rf_params <span class="sc">%&gt;%</span></span>
<span id="cb76-8"><a href="modeling.html#cb76-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(<span class="at">size =</span> <span class="dv">30</span>, <span class="at">original =</span> <span class="cn">FALSE</span>),</span>
<span id="cb76-9"><a href="modeling.html#cb76-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb76-10"><a href="modeling.html#cb76-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb76-11"><a href="modeling.html#cb76-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb76-12"><a href="modeling.html#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="modeling.html#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="co"># visualization of the tuning results (snapshot of the output below)</span></span>
<span id="cb76-14"><a href="modeling.html#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bout_rf_tune) <span class="sc">+</span> <span class="fu">theme_light</span>()</span>
<span id="cb76-15"><a href="modeling.html#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="co"># this functions shows the best combinations wrt the rmse metric of all the</span></span>
<span id="cb76-16"><a href="modeling.html#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="co"># combinations in the grid</span></span>
<span id="cb76-17"><a href="modeling.html#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_rf_tune, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:rfburntuneplot"></span>
<img src="_pictures/rf_burn_tune_plot.png" alt="Result of a spacefilling grid search for the random forest model." width="70%" />
<p class="caption">
Figure 5.1: Result of a spacefilling grid search for the random forest model.
</p>
</div>
<p>The visualization alongside the best performing results suggest that a value of <code>mtry</code>of 3 and 1000 <code>trees</code> should give good results. Thus one can finalize and fit this model.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="modeling.html#cb77-1" aria-hidden="true" tabindex="-1"></a>final_bout_rf_wflow <span class="ot">&lt;-</span> </span>
<span id="cb77-2"><a href="modeling.html#cb77-2" aria-hidden="true" tabindex="-1"></a>  bout_rf_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb77-3"><a href="modeling.html#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">tibble</span>(</span>
<span id="cb77-4"><a href="modeling.html#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="dv">1000</span>,</span>
<span id="cb77-5"><a href="modeling.html#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="dv">3</span></span>
<span id="cb77-6"><a href="modeling.html#cb77-6" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb77-7"><a href="modeling.html#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(burnout_train)</span></code></pre></div>
<p>Now the main <strong>boosting model</strong>.</p>
<p>First tune only the number of trees in order to detect a number of
trees that is ‘large enough.’ Then tune the tree specific arguments.
If one tunes all parameters at the same time the grid grows to large. Moreover a tuning of the trees argument could encourage overfitting. See the book <em>Hands-on Machine Learning with R</em> for a detailed explenation of the tuning strategies.<span class="citation">[<a href="#ref-HandsOnMLwithR" role="doc-biblioref">2</a>]</span></p>
<p>The first tuning round:</p>
<p>To display the discussed impact of different maximum tree depths the first grid search for a good number of trees will besides the kind of standard value 6 also be performed for regression stumps i.e. a value of 1 for the maximum tree depth.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="modeling.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tuning grid just for the #trees one with max tree depth 6 and one with</span></span>
<span id="cb78-2"><a href="modeling.html#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># only stumps for comparison</span></span>
<span id="cb78-3"><a href="modeling.html#cb78-3" aria-hidden="true" tabindex="-1"></a>first_grid_boost_burn_depth6 <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb78-4"><a href="modeling.html#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">250</span>, <span class="dv">2000</span>, <span class="dv">250</span>),</span>
<span id="cb78-5"><a href="modeling.html#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">9</span>,</span>
<span id="cb78-6"><a href="modeling.html#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">6</span>,</span>
<span id="cb78-7"><a href="modeling.html#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.000001</span>,</span>
<span id="cb78-8"><a href="modeling.html#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb78-9"><a href="modeling.html#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb78-10"><a href="modeling.html#cb78-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb78-11"><a href="modeling.html#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="modeling.html#cb78-12" aria-hidden="true" tabindex="-1"></a>first_grid_boost_burn_stumps <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb78-13"><a href="modeling.html#cb78-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">250</span>, <span class="dv">2000</span>, <span class="dv">250</span>),</span>
<span id="cb78-14"><a href="modeling.html#cb78-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">9</span>,</span>
<span id="cb78-15"><a href="modeling.html#cb78-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">1</span>,</span>
<span id="cb78-16"><a href="modeling.html#cb78-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.000001</span>,</span>
<span id="cb78-17"><a href="modeling.html#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb78-18"><a href="modeling.html#cb78-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb78-19"><a href="modeling.html#cb78-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="modeling.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 1 minute</span></span>
<span id="cb79-2"><a href="modeling.html#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb79-3"><a href="modeling.html#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb79-4"><a href="modeling.html#cb79-4" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_first_stumps <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb79-5"><a href="modeling.html#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb79-6"><a href="modeling.html#cb79-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  burnout_folds,</span>
<span id="cb79-7"><a href="modeling.html#cb79-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> first_grid_boost_burn_stumps,</span>
<span id="cb79-8"><a href="modeling.html#cb79-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb79-9"><a href="modeling.html#cb79-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb79-10"><a href="modeling.html#cb79-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb79-11"><a href="modeling.html#cb79-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-12"><a href="modeling.html#cb79-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-13"><a href="modeling.html#cb79-13" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bout_boost_tune_first_stumps) <span class="sc">+</span> <span class="fu">theme_light</span>()</span>
<span id="cb79-14"><a href="modeling.html#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_first_stumps)</span></code></pre></div>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="modeling.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 1 minute</span></span>
<span id="cb80-2"><a href="modeling.html#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb80-3"><a href="modeling.html#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb80-4"><a href="modeling.html#cb80-4" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_first_depth6 <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb80-5"><a href="modeling.html#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb80-6"><a href="modeling.html#cb80-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  burnout_folds,</span>
<span id="cb80-7"><a href="modeling.html#cb80-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> first_grid_boost_burn_depth6,</span>
<span id="cb80-8"><a href="modeling.html#cb80-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb80-9"><a href="modeling.html#cb80-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-10"><a href="modeling.html#cb80-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb80-11"><a href="modeling.html#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="modeling.html#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot output is shown in the figure below</span></span>
<span id="cb80-13"><a href="modeling.html#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bout_boost_tune_first_depth6) <span class="sc">+</span> <span class="fu">theme_light</span>()</span>
<span id="cb80-14"><a href="modeling.html#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_first_depth6)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:boostburntuneplot1"></span>
<img src="_pictures/burn_boost_tune_first.png" alt="Result of the first grid search for the XGBoost model (max depth 6)." width="70%" />
<p class="caption">
Figure 5.2: Result of the first grid search for the XGBoost model (max depth 6).
</p>
</div>
<p>Compare the two different first tuning rounds:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="modeling.html#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># output of this code shown in the figure below</span></span>
<span id="cb81-2"><a href="modeling.html#cb81-2" aria-hidden="true" tabindex="-1"></a>bout_boost_tune_first_stumps <span class="sc">%&gt;%</span></span>
<span id="cb81-3"><a href="modeling.html#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb81-4"><a href="modeling.html#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb81-5"><a href="modeling.html#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb81-6"><a href="modeling.html#cb81-6" aria-hidden="true" tabindex="-1"></a>    bout_boost_tune_first_depth6 <span class="sc">%&gt;%</span></span>
<span id="cb81-7"><a href="modeling.html#cb81-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb81-8"><a href="modeling.html#cb81-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="dv">6</span>)</span>
<span id="cb81-9"><a href="modeling.html#cb81-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb81-10"><a href="modeling.html#cb81-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> trees, <span class="at">y =</span> mean, <span class="at">col =</span> <span class="fu">factor</span>(tree_depth))) <span class="sc">+</span></span>
<span id="cb81-11"><a href="modeling.html#cb81-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb81-12"><a href="modeling.html#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb81-13"><a href="modeling.html#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb81-14"><a href="modeling.html#cb81-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">col =</span> <span class="st">&quot;Max tree depth&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Number of trees&quot;</span>,</span>
<span id="cb81-15"><a href="modeling.html#cb81-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb81-16"><a href="modeling.html#cb81-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;C&quot;</span>) <span class="sc">+</span></span>
<span id="cb81-17"><a href="modeling.html#cb81-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric) <span class="sc">+</span></span>
<span id="cb81-18"><a href="modeling.html#cb81-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:bouttuningstumpsVs6"></span>
<img src="_pictures/bout_tuning_stumpsVs6.png" alt="Comparison of the initial grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates." width="70%" />
<p class="caption">
Figure 5.3: Comparison of the initial grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates.
</p>
</div>
<p>This shows that the model with just stumps converges much slower or may even never reach the low level of when using deeper trees. One reason for this could be that these stumps do not account for interactions and of course the same number of deep trees encode much more information than the same number of stumps.</p>
<p>So 1500 trees should suffice here. Thus the workflow and model will be adjusted accordingly.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="modeling.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fix the number of trees by redefining the boosted model with a </span></span>
<span id="cb82-2"><a href="modeling.html#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed number of trees.</span></span>
<span id="cb82-3"><a href="modeling.html#cb82-3" aria-hidden="true" tabindex="-1"></a>bout_boost_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">1500</span>,</span>
<span id="cb82-4"><a href="modeling.html#cb82-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb82-5"><a href="modeling.html#cb82-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb82-6"><a href="modeling.html#cb82-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb82-7"><a href="modeling.html#cb82-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb82-8"><a href="modeling.html#cb82-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample_size =</span> <span class="fu">tune</span>(),</span>
<span id="cb82-9"><a href="modeling.html#cb82-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stop_iter =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb82-10"><a href="modeling.html#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb82-11"><a href="modeling.html#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span>
<span id="cb82-12"><a href="modeling.html#cb82-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-13"><a href="modeling.html#cb82-13" aria-hidden="true" tabindex="-1"></a><span class="co"># update the workflow</span></span>
<span id="cb82-14"><a href="modeling.html#cb82-14" aria-hidden="true" tabindex="-1"></a>bout_boost_wflow <span class="ot">&lt;-</span></span>
<span id="cb82-15"><a href="modeling.html#cb82-15" aria-hidden="true" tabindex="-1"></a>  bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb82-16"><a href="modeling.html#cb82-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(bout_boost_model)</span>
<span id="cb82-17"><a href="modeling.html#cb82-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-18"><a href="modeling.html#cb82-18" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb82-19"><a href="modeling.html#cb82-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>() <span class="sc">%&gt;%</span></span>
<span id="cb82-20"><a href="modeling.html#cb82-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(burnout_train)</span>
<span id="cb82-21"><a href="modeling.html#cb82-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-22"><a href="modeling.html#cb82-22" aria-hidden="true" tabindex="-1"></a><span class="co"># reduced hyperparameter space</span></span>
<span id="cb82-23"><a href="modeling.html#cb82-23" aria-hidden="true" tabindex="-1"></a>bout_boost_params</span></code></pre></div>
<pre><code>## Collection of 5 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]</code></pre>
<p>Now perform the first major grid search over all the other hyperparameters.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="modeling.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now tune all the remaining hyperparameters with a large space filling grid</span></span>
<span id="cb84-2"><a href="modeling.html#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="modeling.html#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 1.5 hours</span></span>
<span id="cb84-4"><a href="modeling.html#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb84-5"><a href="modeling.html#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb84-6"><a href="modeling.html#cb84-6" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_second <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb84-7"><a href="modeling.html#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb84-8"><a href="modeling.html#cb84-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> burnout_folds,</span>
<span id="cb84-9"><a href="modeling.html#cb84-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb84-10"><a href="modeling.html#cb84-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb84-11"><a href="modeling.html#cb84-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">200</span>),</span>
<span id="cb84-12"><a href="modeling.html#cb84-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb84-13"><a href="modeling.html#cb84-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-14"><a href="modeling.html#cb84-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb84-15"><a href="modeling.html#cb84-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-16"><a href="modeling.html#cb84-16" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_second, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<p>Now refine the grid i.e. the parameter space according to the results of the last grid search and perform a third one.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="modeling.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now tune all the remaining hyperparameters with a refined space filling grid</span></span>
<span id="cb85-2"><a href="modeling.html#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="modeling.html#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 2 hours</span></span>
<span id="cb85-4"><a href="modeling.html#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb85-5"><a href="modeling.html#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb85-6"><a href="modeling.html#cb85-6" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_third <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb85-7"><a href="modeling.html#cb85-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb85-8"><a href="modeling.html#cb85-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> burnout_folds,</span>
<span id="cb85-9"><a href="modeling.html#cb85-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb85-10"><a href="modeling.html#cb85-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">update</span>(</span>
<span id="cb85-11"><a href="modeling.html#cb85-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">mtry =</span> <span class="fu">mtry</span>(<span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">9</span>)),</span>
<span id="cb85-12"><a href="modeling.html#cb85-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">tree_depth =</span> <span class="fu">tree_depth</span>(<span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>)),</span>
<span id="cb85-13"><a href="modeling.html#cb85-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">learn_rate =</span> <span class="fu">learn_rate</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.7</span>, <span class="sc">-</span><span class="fl">1.3</span>)),</span>
<span id="cb85-14"><a href="modeling.html#cb85-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">loss_reduction =</span> <span class="fu">loss_reduction</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">8</span>,<span class="sc">-</span><span class="dv">3</span>)),</span>
<span id="cb85-15"><a href="modeling.html#cb85-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">sample_size =</span> <span class="fu">sample_prop</span>(<span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.9</span>))</span>
<span id="cb85-16"><a href="modeling.html#cb85-16" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb85-17"><a href="modeling.html#cb85-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb85-18"><a href="modeling.html#cb85-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">200</span>),</span>
<span id="cb85-19"><a href="modeling.html#cb85-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb85-20"><a href="modeling.html#cb85-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-21"><a href="modeling.html#cb85-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb85-22"><a href="modeling.html#cb85-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-23"><a href="modeling.html#cb85-23" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_third, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<p>With this final grid search one is ready to finalize the model.</p>
<p>The results of the three grid searches suggest that no column-subsampling should be applied, the maximum tree depth should be 4, the learning rate should be small but not extremely small (<span class="math inline">\(\sim 0.02\)</span>), the loss reduction regularization effect is not needed here (very small) and the sample size for each tree should be set to 0.8.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="modeling.html#cb86-1" aria-hidden="true" tabindex="-1"></a>final_bout_boost_wflow <span class="ot">&lt;-</span> </span>
<span id="cb86-2"><a href="modeling.html#cb86-2" aria-hidden="true" tabindex="-1"></a>  bout_boost_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb86-3"><a href="modeling.html#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">tibble</span>(</span>
<span id="cb86-4"><a href="modeling.html#cb86-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="dv">9</span>,</span>
<span id="cb86-5"><a href="modeling.html#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="dv">4</span>,</span>
<span id="cb86-6"><a href="modeling.html#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> <span class="fl">0.02</span>,</span>
<span id="cb86-7"><a href="modeling.html#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss_reduction =</span> <span class="fl">0.0000003</span>,</span>
<span id="cb86-8"><a href="modeling.html#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="fl">0.8</span></span>
<span id="cb86-9"><a href="modeling.html#cb86-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb86-10"><a href="modeling.html#cb86-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(burnout_train)</span></code></pre></div>
<p>Now tune the <strong>transformed outcome boosting model</strong>.</p>
<p>Again start with the <code>trees</code>.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="modeling.html#cb87-1" aria-hidden="true" tabindex="-1"></a>first_grid_boost_burn_trans <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb87-2"><a href="modeling.html#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">250</span>, <span class="dv">2000</span>, <span class="dv">250</span>),</span>
<span id="cb87-3"><a href="modeling.html#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">9</span>,</span>
<span id="cb87-4"><a href="modeling.html#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">6</span>,</span>
<span id="cb87-5"><a href="modeling.html#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.000001</span>,</span>
<span id="cb87-6"><a href="modeling.html#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb87-7"><a href="modeling.html#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb87-8"><a href="modeling.html#cb87-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="modeling.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 1 minute</span></span>
<span id="cb88-2"><a href="modeling.html#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb88-3"><a href="modeling.html#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb88-4"><a href="modeling.html#cb88-4" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_first_trans <span class="ot">&lt;-</span> bout_boost_wflow_trans <span class="sc">%&gt;%</span></span>
<span id="cb88-5"><a href="modeling.html#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb88-6"><a href="modeling.html#cb88-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  burnout_folds,</span>
<span id="cb88-7"><a href="modeling.html#cb88-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> first_grid_boost_burn_trans,</span>
<span id="cb88-8"><a href="modeling.html#cb88-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb88-9"><a href="modeling.html#cb88-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-10"><a href="modeling.html#cb88-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb88-11"><a href="modeling.html#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="modeling.html#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot output in the figure below</span></span>
<span id="cb88-13"><a href="modeling.html#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bout_boost_tune_first_trans) <span class="sc">+</span> <span class="fu">theme_light</span>()</span>
<span id="cb88-14"><a href="modeling.html#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_first_trans)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:burnboosttunefirsttrans"></span>
<img src="_pictures/burn_boost_tune_first_trans.png" alt="Result of the first grid search for the XGBoost model with transformed outcome." width="70%" />
<p class="caption">
Figure 5.4: Result of the first grid search for the XGBoost model with transformed outcome.
</p>
</div>
<p>Again 1500 trees should easily suffice.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="modeling.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fix the number of trees by redefining the boosted model with a </span></span>
<span id="cb89-2"><a href="modeling.html#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed number of trees.</span></span>
<span id="cb89-3"><a href="modeling.html#cb89-3" aria-hidden="true" tabindex="-1"></a>bout_boost_model_trans <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">1500</span>,</span>
<span id="cb89-4"><a href="modeling.html#cb89-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-5"><a href="modeling.html#cb89-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-6"><a href="modeling.html#cb89-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-7"><a href="modeling.html#cb89-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-8"><a href="modeling.html#cb89-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample_size =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-9"><a href="modeling.html#cb89-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stop_iter =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-10"><a href="modeling.html#cb89-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb89-11"><a href="modeling.html#cb89-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span>
<span id="cb89-12"><a href="modeling.html#cb89-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-13"><a href="modeling.html#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="co"># update the workflow</span></span>
<span id="cb89-14"><a href="modeling.html#cb89-14" aria-hidden="true" tabindex="-1"></a>bout_boost_wflow_trans <span class="ot">&lt;-</span></span>
<span id="cb89-15"><a href="modeling.html#cb89-15" aria-hidden="true" tabindex="-1"></a>  bout_boost_wflow_trans <span class="sc">%&gt;%</span></span>
<span id="cb89-16"><a href="modeling.html#cb89-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(bout_boost_model_trans)</span>
<span id="cb89-17"><a href="modeling.html#cb89-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-18"><a href="modeling.html#cb89-18" aria-hidden="true" tabindex="-1"></a>bout_boost_params_trans <span class="ot">&lt;-</span> bout_boost_wflow_trans <span class="sc">%&gt;%</span></span>
<span id="cb89-19"><a href="modeling.html#cb89-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>() <span class="sc">%&gt;%</span></span>
<span id="cb89-20"><a href="modeling.html#cb89-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(burnout_train)</span>
<span id="cb89-21"><a href="modeling.html#cb89-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-22"><a href="modeling.html#cb89-22" aria-hidden="true" tabindex="-1"></a><span class="co"># reduced hyperparameter space</span></span>
<span id="cb89-23"><a href="modeling.html#cb89-23" aria-hidden="true" tabindex="-1"></a>bout_boost_params_trans</span></code></pre></div>
<pre><code>## Collection of 5 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]</code></pre>
<p>Now perform the first major grid search over all the other hyperparameters and the second one overall.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="modeling.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now tune all the remaining hyperparameters with a large space filling grid</span></span>
<span id="cb91-2"><a href="modeling.html#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="modeling.html#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 2 hours</span></span>
<span id="cb91-4"><a href="modeling.html#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb91-5"><a href="modeling.html#cb91-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb91-6"><a href="modeling.html#cb91-6" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_second_trans <span class="ot">&lt;-</span> bout_boost_wflow_trans <span class="sc">%&gt;%</span></span>
<span id="cb91-7"><a href="modeling.html#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb91-8"><a href="modeling.html#cb91-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> burnout_folds,</span>
<span id="cb91-9"><a href="modeling.html#cb91-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> bout_boost_params_trans <span class="sc">%&gt;%</span></span>
<span id="cb91-10"><a href="modeling.html#cb91-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb91-11"><a href="modeling.html#cb91-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">200</span>),</span>
<span id="cb91-12"><a href="modeling.html#cb91-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb91-13"><a href="modeling.html#cb91-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb91-14"><a href="modeling.html#cb91-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb91-15"><a href="modeling.html#cb91-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-16"><a href="modeling.html#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_second_trans, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<p>From the tuning results one can conclude that in this setting actually the same hyperparameter setting as for the raw target variable seems appropriate. So one finalizes the workflow with the same hyperparameters and fits the model.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="modeling.html#cb92-1" aria-hidden="true" tabindex="-1"></a>final_bout_boost_wflow_trans <span class="ot">&lt;-</span> </span>
<span id="cb92-2"><a href="modeling.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  bout_boost_wflow_trans <span class="sc">%&gt;%</span> </span>
<span id="cb92-3"><a href="modeling.html#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">tibble</span>(</span>
<span id="cb92-4"><a href="modeling.html#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="dv">9</span>,</span>
<span id="cb92-5"><a href="modeling.html#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="dv">4</span>,</span>
<span id="cb92-6"><a href="modeling.html#cb92-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> <span class="fl">0.02</span>,</span>
<span id="cb92-7"><a href="modeling.html#cb92-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss_reduction =</span> <span class="fl">0.0000003</span>,</span>
<span id="cb92-8"><a href="modeling.html#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="fl">0.8</span></span>
<span id="cb92-9"><a href="modeling.html#cb92-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb92-10"><a href="modeling.html#cb92-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(burnout_train)</span></code></pre></div>
<p>Now all models w.r.t. the burnout data set are fitted.</p>
</div>
<div id="evaluate-and-understand-the-model" class="section level3" number="5.1.4">
<h3><span class="header-section-number">5.1.4</span> Evaluate and understand the model</h3>
<p>First a visualization of the variable importance. The variable importance is basically calculated by measuring the gain w.r.t. the loss of each feature in the single trees and splits.</p>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-85-1.png" width="672" /></p>
<p>This shows that indeed the <code>mental_fatigue_score</code> is the most influential predictor by far followed by the <code>ressource_allocation</code> and <code>designation</code> features. These results are not at all surprising as the EDA exactly came to these conclusions. Especially the very few appearances of the features connected to <code>company_type</code> and <code>date_of_joining</code> are most likely just some minor overfitting.</p>
<p>Now compare the variable importance of the model with the raw and the transformed target variable.</p>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-86-1.png" width="672" /></p>
<p>One can observe the exact same ordering. The only difference seems to be a higher influence of the designation variable for the transformed target. This is not surprising as the resource allocation and designation variable are highly correlated.</p>
<p>Now have a look at the performance of the main boosting model w.r.t. missing values in the most influential variable.</p>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-87-1.png" width="672" /><img src="boosting_methods_files/figure-html/unnamed-chunk-87-2.png" width="672" /></p>
<p>The performance for the missing values is indeed not that precise but still quite good. There is at least no huge outlier detectable here. While at first glance the fact that outliers are handled naturally by the model is not astonishing it really is one the core strengths of the model to deal with messy data that includes missing and sparse data. So there is no need for imputation or a second fallback model for missing values.</p>
<p>Now it is interesting to check which model performed the best on the test data set. The results can be viewed below in tabular and graphical form.</p>
<table>
<caption><span id="tab:perfBurn">Table 5.1: </span>Performance on the test data</caption>
<thead>
<tr class="header">
<th align="left">model</th>
<th align="right">mae</th>
<th align="right">rmse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">boost_pred</td>
<td align="right">0.0467</td>
<td align="right">0.0593</td>
</tr>
<tr class="even">
<td align="left">boost_trans_pred</td>
<td align="right">0.0467</td>
<td align="right">0.0593</td>
</tr>
<tr class="odd">
<td align="left">rf_pred</td>
<td align="right">0.0474</td>
<td align="right">0.0612</td>
</tr>
<tr class="even">
<td align="left">mfs_scored_pred</td>
<td align="right">0.0628</td>
<td align="right">0.0870</td>
</tr>
<tr class="odd">
<td align="left">intercept_pred</td>
<td align="right">0.1593</td>
<td align="right">0.1980</td>
</tr>
</tbody>
</table>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-88-1.png" width="672" /></p>
<p>It can be observed that already the really simple baseline model that just scales the mental fatigue score (so it reflects just a single linear influence) has a really low MAE and RMSE. Still both random forest as well as the boosting model can further improve this metric but the huge linear influence of the mental fatigue score obviously leaves not much room for improvement. By the way the simple linear model with just this one predictor has already an <span class="math inline">\(R^2\)</span> of more than 0.92. XGBoost manages to get a slightly better performance on the test data set but this would only be nice in a machine learning competition as in real life this difference would negligible. Actually in this use case for a real life application a very easy explainable linear model might be somewhat better than a complex model like XGBoost as the difference in performance is not too big. Nevertheless in my opinion the predictor <code>mental_fatigue_score</code> should be treated with extreme care as in a real life situation the collection of this score could be as costly or hard as the one of the outcome. There might be even latent variables that are highly linearly correlated to both scores. But this data was not intended to be used in a real life application but was shared at a machine learning competition and actually many of the best submissions there used XGBoost models. The transformation of the outcome variable did actually not change the predictive power of the model as the result for both the model with the raw target as well as the one with the transformed one performed equally good. Below one can see a scatterplot comparing the individual predictions of these two models on the test set which perfectly underlines the hypothesis that the models are basically the same as there is almost no variation around the identity slope.</p>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-89-1.png" width="672" /></p>
<p>So all in all for this data set it was not a way better predictive performance (if one is not in an artificial machine learning setup) that was the core strength of the tree-based gradient boosting model but the minimal pre-processing and exploratory work (for example no interactions have to be detected manually or be tested for significance) that was needed and the natural handling of missing values to achieve the model. This of course came to a quite high computational price. The famous predictive performance could probably be displayed better when having a data set with more complex non-linear patterns.</p>
<p>This finishes the analysis of the burnout data set. But no worries there is still one data set and boosting model left to explore namely the insurance data set.</p>
</div>
</div>
<div id="insurance-data" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Insurance data</h2>
<div id="baseline-models-1" class="section level3" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Baseline models</h3>
<p>The first thing is to set up the trivial <strong>baseline models</strong>.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="modeling.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the trivial intercept only model:</span></span>
<span id="cb93-2"><a href="modeling.html#cb93-2" aria-hidden="true" tabindex="-1"></a>ins_predict_trivial_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(new_data) {</span>
<span id="cb93-3"><a href="modeling.html#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rep</span>(<span class="fu">mean</span>(ins_train<span class="sc">$</span>log10_charges), <span class="fu">nrow</span>(new_data))</span>
<span id="cb93-4"><a href="modeling.html#cb93-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb93-5"><a href="modeling.html#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="modeling.html#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the trivial linear model without any interactions (as we do not have </span></span>
<span id="cb93-7"><a href="modeling.html#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="co"># missing values does not have to be dealt with them)</span></span>
<span id="cb93-8"><a href="modeling.html#cb93-8" aria-hidden="true" tabindex="-1"></a>ins_baseline_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(log10_charges <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> bmi <span class="sc">+</span></span>
<span id="cb93-9"><a href="modeling.html#cb93-9" aria-hidden="true" tabindex="-1"></a>                        children <span class="sc">+</span> smoker <span class="sc">+</span> region,</span>
<span id="cb93-10"><a href="modeling.html#cb93-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ins_train <span class="sc">%&gt;%</span> </span>
<span id="cb93-11"><a href="modeling.html#cb93-11" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), as.factor)))</span>
<span id="cb93-12"><a href="modeling.html#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ins_baseline_lm)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = log10_charges ~ age + sex + bmi + children + smoker + 
##     region, data = ins_train %&gt;% mutate(across(where(is.character), 
##     as.factor)))
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.46395 -0.08466 -0.01955  0.02643  0.93557 
## 
## Coefficients:
##                   Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)      3.0685262  0.0357167  85.913  &lt; 2e-16 ***
## age              0.0149190  0.0004316  34.566  &lt; 2e-16 ***
## sexmale         -0.0251970  0.0119527  -2.108 0.035260 *  
## bmi              0.0052551  0.0010243   5.130 3.44e-07 ***
## children         0.0413979  0.0050235   8.241 5.00e-16 ***
## smokeryes        0.6841462  0.0147963  46.238  &lt; 2e-16 ***
## regionnorthwest -0.0178125  0.0172137  -1.035 0.301003    
## regionsoutheast -0.0613744  0.0172229  -3.564 0.000382 ***
## regionsouthwest -0.0512729  0.0172868  -2.966 0.003084 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.1945 on 1061 degrees of freedom
## Multiple R-squared:  0.764,  Adjusted R-squared:  0.7622 
## F-statistic: 429.4 on 8 and 1061 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>The predictions of these baseline models on the test data set will be compared with the predictions of the tree-based models that will be constructed.</p>
</div>
<div id="model-specification-1" class="section level3" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Model specification</h3>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="modeling.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Models:</span></span>
<span id="cb95-2"><a href="modeling.html#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="modeling.html#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Random forest model for comparison</span></span>
<span id="cb95-4"><a href="modeling.html#cb95-4" aria-hidden="true" tabindex="-1"></a>ins_rf_model <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb95-5"><a href="modeling.html#cb95-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mtry =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb95-6"><a href="modeling.html#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;ranger&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-7"><a href="modeling.html#cb95-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span>
<span id="cb95-8"><a href="modeling.html#cb95-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-9"><a href="modeling.html#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="co"># XGBoost model</span></span>
<span id="cb95-10"><a href="modeling.html#cb95-10" aria-hidden="true" tabindex="-1"></a>ins_boost_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb95-11"><a href="modeling.html#cb95-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb95-12"><a href="modeling.html#cb95-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb95-13"><a href="modeling.html#cb95-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb95-14"><a href="modeling.html#cb95-14" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb95-15"><a href="modeling.html#cb95-15" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample_size =</span> <span class="fu">tune</span>(),</span>
<span id="cb95-16"><a href="modeling.html#cb95-16" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stop_iter =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-17"><a href="modeling.html#cb95-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-18"><a href="modeling.html#cb95-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="modeling.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Workflows: model + recipe</span></span>
<span id="cb96-2"><a href="modeling.html#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="modeling.html#cb96-3" aria-hidden="true" tabindex="-1"></a>ins_rf_wflow <span class="ot">&lt;-</span></span>
<span id="cb96-4"><a href="modeling.html#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb96-5"><a href="modeling.html#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(ins_rf_model) <span class="sc">%&gt;%</span></span>
<span id="cb96-6"><a href="modeling.html#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ins_rec_rf)</span>
<span id="cb96-7"><a href="modeling.html#cb96-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-8"><a href="modeling.html#cb96-8" aria-hidden="true" tabindex="-1"></a>ins_boost_wflow <span class="ot">&lt;-</span></span>
<span id="cb96-9"><a href="modeling.html#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb96-10"><a href="modeling.html#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(ins_boost_model) <span class="sc">%&gt;%</span></span>
<span id="cb96-11"><a href="modeling.html#cb96-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ins_rec_boost)</span></code></pre></div>
</div>
<div id="tuning-1" class="section level3" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Tuning</h3>
<p>For the hyperparameter tuning one needs validation sets to monitor the models on unseen data. To do this 5-fold cross validation (CV) is used here.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="modeling.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Resampling object</span></span>
<span id="cb97-2"><a href="modeling.html#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb97-3"><a href="modeling.html#cb97-3" aria-hidden="true" tabindex="-1"></a>ins_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ins_train, <span class="at">v =</span> <span class="dv">5</span>)</span></code></pre></div>
<p>Now the parameter objects will be fixed for the grid searches analogously to above.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="modeling.html#cb98-1" aria-hidden="true" tabindex="-1"></a>ins_rf_params <span class="ot">&lt;-</span> ins_rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb98-2"><a href="modeling.html#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>() <span class="sc">%&gt;%</span></span>
<span id="cb98-3"><a href="modeling.html#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">trees =</span> <span class="fu">trees</span>(<span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">2000</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb98-4"><a href="modeling.html#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(ins_train)</span>
<span id="cb98-5"><a href="modeling.html#cb98-5" aria-hidden="true" tabindex="-1"></a>ins_rf_params <span class="sc">%&gt;%</span> <span class="fu">pull_dials_object</span>(<span class="st">&quot;trees&quot;</span>)</span></code></pre></div>
<pre><code>## # Trees (quantitative)
## Range: [100, 2000]</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="modeling.html#cb100-1" aria-hidden="true" tabindex="-1"></a>ins_rf_params <span class="sc">%&gt;%</span> <span class="fu">pull_dials_object</span>(<span class="st">&quot;mtry&quot;</span>)</span></code></pre></div>
<pre><code>## # Randomly Selected Predictors (quantitative)
## Range: [1, 8]</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="modeling.html#cb102-1" aria-hidden="true" tabindex="-1"></a>ins_boost_params <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb102-2"><a href="modeling.html#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>() <span class="sc">%&gt;%</span></span>
<span id="cb102-3"><a href="modeling.html#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">trees =</span> <span class="fu">trees</span>(<span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">2000</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb102-4"><a href="modeling.html#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(ins_train)</span>
<span id="cb102-5"><a href="modeling.html#cb102-5" aria-hidden="true" tabindex="-1"></a>ins_boost_params</span></code></pre></div>
<pre><code>## Collection of 6 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[+]
##           trees          trees nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]</code></pre>
<p>The <strong>random forest model</strong> goes first with the tuning.</p>
<p>Here there are as seen above only two hyperparameters to be tuned thus 30 combinations should suffice.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="modeling.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 2 minutes</span></span>
<span id="cb104-2"><a href="modeling.html#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb104-3"><a href="modeling.html#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb104-4"><a href="modeling.html#cb104-4" aria-hidden="true" tabindex="-1"></a>  ins_rf_tune <span class="ot">&lt;-</span> ins_rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb104-5"><a href="modeling.html#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb104-6"><a href="modeling.html#cb104-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  ins_folds,</span>
<span id="cb104-7"><a href="modeling.html#cb104-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> ins_rf_params <span class="sc">%&gt;%</span></span>
<span id="cb104-8"><a href="modeling.html#cb104-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(<span class="at">size =</span> <span class="dv">30</span>, <span class="at">original =</span> <span class="cn">FALSE</span>),</span>
<span id="cb104-9"><a href="modeling.html#cb104-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb104-10"><a href="modeling.html#cb104-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb104-11"><a href="modeling.html#cb104-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb104-12"><a href="modeling.html#cb104-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-13"><a href="modeling.html#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="co"># visualization of the tuning results (snapshot of the output below)</span></span>
<span id="cb104-14"><a href="modeling.html#cb104-14" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ins_rf_tune) <span class="sc">+</span> <span class="fu">theme_light</span>()</span>
<span id="cb104-15"><a href="modeling.html#cb104-15" aria-hidden="true" tabindex="-1"></a><span class="co"># this functions shows the best combinations wrt the rmse metric of all the</span></span>
<span id="cb104-16"><a href="modeling.html#cb104-16" aria-hidden="true" tabindex="-1"></a><span class="co"># combinations in the grid</span></span>
<span id="cb104-17"><a href="modeling.html#cb104-17" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_rf_tune, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:rfInstuneplot"></span>
<img src="_pictures/rf_ins_tune_plot.png" alt="Result of a spacefilling grid search for the random forest model." width="70%" />
<p class="caption">
Figure 5.5: Result of a spacefilling grid search for the random forest model.
</p>
</div>
<p>The visualization alongside the best performing results suggest that a value of <code>mtry</code>of 4 and 1000 <code>trees</code> should give good results. Thus one can finalize and fit this model.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="modeling.html#cb105-1" aria-hidden="true" tabindex="-1"></a>final_ins_rf_wflow <span class="ot">&lt;-</span> </span>
<span id="cb105-2"><a href="modeling.html#cb105-2" aria-hidden="true" tabindex="-1"></a>  ins_rf_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb105-3"><a href="modeling.html#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">tibble</span>(</span>
<span id="cb105-4"><a href="modeling.html#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="dv">1000</span>,</span>
<span id="cb105-5"><a href="modeling.html#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="dv">4</span></span>
<span id="cb105-6"><a href="modeling.html#cb105-6" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb105-7"><a href="modeling.html#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ins_train)</span></code></pre></div>
<p>Now the <strong>boosting model</strong>.</p>
<p>Again one starts to tune over the number of trees first (this time we also use three different tree depths to visualize the impact of this parameter too)</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="modeling.html#cb106-1" aria-hidden="true" tabindex="-1"></a>first_grid_boost_ins <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb106-2"><a href="modeling.html#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">250</span>, <span class="dv">2000</span>, <span class="dv">250</span>),</span>
<span id="cb106-3"><a href="modeling.html#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">8</span>,</span>
<span id="cb106-4"><a href="modeling.html#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">6</span>),</span>
<span id="cb106-5"><a href="modeling.html#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.000001</span>,</span>
<span id="cb106-6"><a href="modeling.html#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb106-7"><a href="modeling.html#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb106-8"><a href="modeling.html#cb106-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="modeling.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly half a minute</span></span>
<span id="cb107-2"><a href="modeling.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb107-3"><a href="modeling.html#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb107-4"><a href="modeling.html#cb107-4" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_first <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb107-5"><a href="modeling.html#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb107-6"><a href="modeling.html#cb107-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  ins_folds,</span>
<span id="cb107-7"><a href="modeling.html#cb107-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> first_grid_boost_ins,</span>
<span id="cb107-8"><a href="modeling.html#cb107-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb107-9"><a href="modeling.html#cb107-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb107-10"><a href="modeling.html#cb107-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb107-11"><a href="modeling.html#cb107-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-12"><a href="modeling.html#cb107-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-13"><a href="modeling.html#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_first)</span></code></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="modeling.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the tuning results (output in the figure below)</span></span>
<span id="cb108-2"><a href="modeling.html#cb108-2" aria-hidden="true" tabindex="-1"></a>ins_boost_tune_first <span class="sc">%&gt;%</span></span>
<span id="cb108-3"><a href="modeling.html#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb108-4"><a href="modeling.html#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> trees, <span class="at">y =</span> mean, <span class="at">col =</span> <span class="fu">factor</span>(tree_depth))) <span class="sc">+</span></span>
<span id="cb108-5"><a href="modeling.html#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb108-6"><a href="modeling.html#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb108-7"><a href="modeling.html#cb108-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb108-8"><a href="modeling.html#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">col =</span> <span class="st">&quot;Max tree depth&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Number of trees&quot;</span>,</span>
<span id="cb108-9"><a href="modeling.html#cb108-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb108-10"><a href="modeling.html#cb108-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;C&quot;</span>) <span class="sc">+</span></span>
<span id="cb108-11"><a href="modeling.html#cb108-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric) <span class="sc">+</span></span>
<span id="cb108-12"><a href="modeling.html#cb108-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:boostInstuneplot1"></span>
<img src="_pictures/boost_ins_tune_plot1.png" alt="Comparison of the initial grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates." width="70%" />
<p class="caption">
Figure 5.6: Comparison of the initial grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates.
</p>
</div>
<p>This visualization clearly shows that one has to have a closer look at the region around 500 trees. More than 500 trees might lead to overfitting as seen here.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="modeling.html#cb109-1" aria-hidden="true" tabindex="-1"></a>second_grid_boost_ins <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb109-2"><a href="modeling.html#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">250</span>, <span class="dv">750</span>, <span class="dv">50</span>),</span>
<span id="cb109-3"><a href="modeling.html#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">8</span>,</span>
<span id="cb109-4"><a href="modeling.html#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>),</span>
<span id="cb109-5"><a href="modeling.html#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.000001</span>,</span>
<span id="cb109-6"><a href="modeling.html#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb109-7"><a href="modeling.html#cb109-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb109-8"><a href="modeling.html#cb109-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="modeling.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 15 seconds</span></span>
<span id="cb110-2"><a href="modeling.html#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb110-3"><a href="modeling.html#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb110-4"><a href="modeling.html#cb110-4" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_second <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb110-5"><a href="modeling.html#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb110-6"><a href="modeling.html#cb110-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  ins_folds,</span>
<span id="cb110-7"><a href="modeling.html#cb110-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> second_grid_boost_ins,</span>
<span id="cb110-8"><a href="modeling.html#cb110-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb110-9"><a href="modeling.html#cb110-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb110-10"><a href="modeling.html#cb110-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb110-11"><a href="modeling.html#cb110-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-12"><a href="modeling.html#cb110-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-13"><a href="modeling.html#cb110-13" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_second)</span></code></pre></div>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="modeling.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the tuning results (output in the figure below)</span></span>
<span id="cb111-2"><a href="modeling.html#cb111-2" aria-hidden="true" tabindex="-1"></a>ins_boost_tune_second <span class="sc">%&gt;%</span></span>
<span id="cb111-3"><a href="modeling.html#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb111-4"><a href="modeling.html#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> trees, <span class="at">y =</span> mean, <span class="at">col =</span> <span class="fu">factor</span>(tree_depth))) <span class="sc">+</span></span>
<span id="cb111-5"><a href="modeling.html#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb111-6"><a href="modeling.html#cb111-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb111-7"><a href="modeling.html#cb111-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb111-8"><a href="modeling.html#cb111-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">col =</span> <span class="st">&quot;Max tree depth&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Number of trees&quot;</span>,</span>
<span id="cb111-9"><a href="modeling.html#cb111-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb111-10"><a href="modeling.html#cb111-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;C&quot;</span>) <span class="sc">+</span></span>
<span id="cb111-11"><a href="modeling.html#cb111-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric) <span class="sc">+</span></span>
<span id="cb111-12"><a href="modeling.html#cb111-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:boostInstuneplot2"></span>
<img src="_pictures/boost_ins_tune_plot2.png" alt="Comparison of the second grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates." width="70%" />
<p class="caption">
Figure 5.7: Comparison of the second grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates.
</p>
</div>
<p>So from this visualization one can conclude that a number of trees of 600 should suffice to get a decent model. So the workflow will be updated and the number of trees fixed. After that the first major space filling grid search will be performed. Moreover with the previous visualizations in mind one can reduce the bound of the parameter space of the maximum tree depth quite a bit from 15 to 9. A minimum tree depth of 2 seems also appropriate.
Before one does that mainly for a view on the influence of the learning rate one can tune one round only with the learning rate and some tree numbers for comparison.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="modeling.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tune mainly learn rate</span></span>
<span id="cb112-2"><a href="modeling.html#cb112-2" aria-hidden="true" tabindex="-1"></a>lrate_grid_boost_ins <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb112-3"><a href="modeling.html#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">200</span>, <span class="dv">1500</span>, <span class="dv">100</span>),</span>
<span id="cb112-4"><a href="modeling.html#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">8</span>,</span>
<span id="cb112-5"><a href="modeling.html#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">c</span>(<span class="dv">3</span>),</span>
<span id="cb112-6"><a href="modeling.html#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fu">c</span>(<span class="fl">0.000001</span>),</span>
<span id="cb112-7"><a href="modeling.html#cb112-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.01</span>, <span class="fl">0.001</span>, <span class="fl">0.0001</span>),</span>
<span id="cb112-8"><a href="modeling.html#cb112-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb112-9"><a href="modeling.html#cb112-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="modeling.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 20 seconds</span></span>
<span id="cb113-2"><a href="modeling.html#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb113-3"><a href="modeling.html#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb113-4"><a href="modeling.html#cb113-4" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_lrate <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb113-5"><a href="modeling.html#cb113-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb113-6"><a href="modeling.html#cb113-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  ins_folds,</span>
<span id="cb113-7"><a href="modeling.html#cb113-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> lrate_grid_boost_ins,</span>
<span id="cb113-8"><a href="modeling.html#cb113-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb113-9"><a href="modeling.html#cb113-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb113-10"><a href="modeling.html#cb113-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb113-11"><a href="modeling.html#cb113-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-12"><a href="modeling.html#cb113-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-13"><a href="modeling.html#cb113-13" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_lrate)</span></code></pre></div>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="modeling.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the tuning results (output in the figure below)</span></span>
<span id="cb114-2"><a href="modeling.html#cb114-2" aria-hidden="true" tabindex="-1"></a>ins_boost_tune_lrate <span class="sc">%&gt;%</span></span>
<span id="cb114-3"><a href="modeling.html#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb114-4"><a href="modeling.html#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> trees, <span class="at">y =</span> mean, <span class="at">col =</span> <span class="fu">factor</span>(learn_rate))) <span class="sc">+</span></span>
<span id="cb114-5"><a href="modeling.html#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb114-6"><a href="modeling.html#cb114-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb114-7"><a href="modeling.html#cb114-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb114-8"><a href="modeling.html#cb114-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Number of trees&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">col =</span> <span class="st">&quot;Learning rate&quot;</span>,</span>
<span id="cb114-9"><a href="modeling.html#cb114-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb114-10"><a href="modeling.html#cb114-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;C&quot;</span>) <span class="sc">+</span></span>
<span id="cb114-11"><a href="modeling.html#cb114-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric) <span class="sc">+</span></span>
<span id="cb114-12"><a href="modeling.html#cb114-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:boostInstuneplotlrate"></span>
<img src="_pictures/boost_ins_tune_lrate.png" alt="Comparison of the grid search for the number of trees w.r.t. the learning rate. Actually with tiny confidence bands around the estimates." width="70%" />
<p class="caption">
Figure 5.8: Comparison of the grid search for the number of trees w.r.t. the learning rate. Actually with tiny confidence bands around the estimates.
</p>
</div>
<p>This showcases the fact that indeed a learning rate that is too small can blow up the computational costs.</p>
<p>Now fix the number of the <code>trees</code> hyperparameter.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="modeling.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fix the number of trees by redefining the boostin model with a </span></span>
<span id="cb115-2"><a href="modeling.html#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed number of trees.</span></span>
<span id="cb115-3"><a href="modeling.html#cb115-3" aria-hidden="true" tabindex="-1"></a>ins_boost_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">600</span>,</span>
<span id="cb115-4"><a href="modeling.html#cb115-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb115-5"><a href="modeling.html#cb115-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb115-6"><a href="modeling.html#cb115-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb115-7"><a href="modeling.html#cb115-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb115-8"><a href="modeling.html#cb115-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample_size =</span> <span class="fu">tune</span>(),</span>
<span id="cb115-9"><a href="modeling.html#cb115-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stop_iter =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb115-10"><a href="modeling.html#cb115-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb115-11"><a href="modeling.html#cb115-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span>
<span id="cb115-12"><a href="modeling.html#cb115-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-13"><a href="modeling.html#cb115-13" aria-hidden="true" tabindex="-1"></a><span class="co"># update the workflow</span></span>
<span id="cb115-14"><a href="modeling.html#cb115-14" aria-hidden="true" tabindex="-1"></a>ins_boost_wflow <span class="ot">&lt;-</span></span>
<span id="cb115-15"><a href="modeling.html#cb115-15" aria-hidden="true" tabindex="-1"></a>  ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb115-16"><a href="modeling.html#cb115-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(ins_boost_model)</span>
<span id="cb115-17"><a href="modeling.html#cb115-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-18"><a href="modeling.html#cb115-18" aria-hidden="true" tabindex="-1"></a>ins_boost_params <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb115-19"><a href="modeling.html#cb115-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>() <span class="sc">%&gt;%</span></span>
<span id="cb115-20"><a href="modeling.html#cb115-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">tree_depth =</span> <span class="fu">tree_depth</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">9</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb115-21"><a href="modeling.html#cb115-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(ins_train)</span>
<span id="cb115-22"><a href="modeling.html#cb115-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-23"><a href="modeling.html#cb115-23" aria-hidden="true" tabindex="-1"></a><span class="co"># reduced hyperparameter space</span></span>
<span id="cb115-24"><a href="modeling.html#cb115-24" aria-hidden="true" tabindex="-1"></a>ins_boost_params</span></code></pre></div>
<pre><code>## Collection of 5 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="modeling.html#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now tune all the remaining hyperparameters with a large space filling grid</span></span>
<span id="cb117-2"><a href="modeling.html#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="modeling.html#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 10 minutes</span></span>
<span id="cb117-4"><a href="modeling.html#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb117-5"><a href="modeling.html#cb117-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb117-6"><a href="modeling.html#cb117-6" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_major1 <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb117-7"><a href="modeling.html#cb117-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb117-8"><a href="modeling.html#cb117-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> ins_folds,</span>
<span id="cb117-9"><a href="modeling.html#cb117-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> ins_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb117-10"><a href="modeling.html#cb117-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb117-11"><a href="modeling.html#cb117-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">300</span>),</span>
<span id="cb117-12"><a href="modeling.html#cb117-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb117-13"><a href="modeling.html#cb117-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb117-14"><a href="modeling.html#cb117-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb117-15"><a href="modeling.html#cb117-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-16"><a href="modeling.html#cb117-16" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_major1, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:insparallelcoord"></span>
<img src="_pictures/tuning_ins_parallelcoord.png" alt="Visualize the tuning results with a parallel coordinate plot. The y axis represents the scaled range for each of the hyperparameter spaces." width="70%" />
<p class="caption">
Figure 5.9: Visualize the tuning results with a parallel coordinate plot. The y axis represents the scaled range for each of the hyperparameter spaces.
</p>
</div>
<p>The most prominent suggestions of the visualizations and the table of the best performing ones are combinations of hyperparameters with a very low <code>loss_reduction</code> , a low <code>learn_rate</code>, a medium to high value of <code>mtry</code>, a not too big <code>tree_depth</code> as well as a rather high value for the <code>sample_size</code>.
These observations will be used to refine the search space and perform once more a space filling grid search.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="modeling.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now tune all the remaining hyperparameters with a refined space filling grid</span></span>
<span id="cb118-2"><a href="modeling.html#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="modeling.html#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 15 minutes</span></span>
<span id="cb118-4"><a href="modeling.html#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb118-5"><a href="modeling.html#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb118-6"><a href="modeling.html#cb118-6" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_major2 <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb118-7"><a href="modeling.html#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb118-8"><a href="modeling.html#cb118-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> ins_folds,</span>
<span id="cb118-9"><a href="modeling.html#cb118-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> ins_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb118-10"><a href="modeling.html#cb118-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">update</span>(</span>
<span id="cb118-11"><a href="modeling.html#cb118-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">mtry =</span> <span class="fu">mtry</span>(<span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">8</span>)),</span>
<span id="cb118-12"><a href="modeling.html#cb118-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">tree_depth =</span> <span class="fu">tree_depth</span>(<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>)),</span>
<span id="cb118-13"><a href="modeling.html#cb118-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">learn_rate =</span> <span class="fu">learn_rate</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.7</span>, <span class="sc">-</span><span class="fl">1.5</span>)),</span>
<span id="cb118-14"><a href="modeling.html#cb118-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">loss_reduction =</span> <span class="fu">loss_reduction</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="sc">-</span><span class="fl">1.5</span>)),</span>
<span id="cb118-15"><a href="modeling.html#cb118-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">sample_size =</span> <span class="fu">sample_prop</span>(<span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.9</span>))</span>
<span id="cb118-16"><a href="modeling.html#cb118-16" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb118-17"><a href="modeling.html#cb118-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb118-18"><a href="modeling.html#cb118-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">300</span>),</span>
<span id="cb118-19"><a href="modeling.html#cb118-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb118-20"><a href="modeling.html#cb118-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb118-21"><a href="modeling.html#cb118-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb118-22"><a href="modeling.html#cb118-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-23"><a href="modeling.html#cb118-23" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_major2, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<p>The results from this grid search were quite clear. One will further use a <code>mtry</code> value of 7, a <code>tree_depth</code> of 3, a <code>learn_rate</code> of 0.02, a <code>loss_reduction</code> of 0.03 and a <code>sample_size</code> of 0.8.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="modeling.html#cb119-1" aria-hidden="true" tabindex="-1"></a>final_ins_boost_wflow <span class="ot">&lt;-</span> </span>
<span id="cb119-2"><a href="modeling.html#cb119-2" aria-hidden="true" tabindex="-1"></a>  ins_boost_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb119-3"><a href="modeling.html#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">tibble</span>(</span>
<span id="cb119-4"><a href="modeling.html#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="dv">7</span>,</span>
<span id="cb119-5"><a href="modeling.html#cb119-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="dv">3</span>,</span>
<span id="cb119-6"><a href="modeling.html#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> <span class="fl">0.02</span>,</span>
<span id="cb119-7"><a href="modeling.html#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss_reduction =</span> <span class="fl">0.03</span>,</span>
<span id="cb119-8"><a href="modeling.html#cb119-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="fl">0.8</span></span>
<span id="cb119-9"><a href="modeling.html#cb119-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb119-10"><a href="modeling.html#cb119-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ins_train)</span></code></pre></div>
<p>From here no computational intensive task will be performed so one stops the cluster.</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="modeling.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stop cluster</span></span>
<span id="cb120-2"><a href="modeling.html#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code></pre></div>
</div>
<div id="evaluate-and-understand-the-model-1" class="section level3" number="5.2.4">
<h3><span class="header-section-number">5.2.4</span> Evaluate and understand the model</h3>
<p>First a visualization of the variable importance. The variable importance is again calculated by measuring the gain w.r.t. the loss of each feature in the single trees and splits.</p>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-104-1.png" width="672" /></p>
<p>Here one can clearly see that the trends that were observable during the EDA are reflected here again. The most influential variable is indeed the smoker variable, closely followed by the age variable. Also the bmi and the number of children seem to be relevant. To get an even better sense for where which variable was mostly used one can have a look at the visualization below which shows the final model in a compressed form as a single tree. At each node the most important (again by the feature importance score like above) 5 variables are listed with their respective raw importance scores in brackets. The ‘Leaf’ variable just corresponds to the case where trees ended at this point.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="modeling.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization of the ensemble of trees as a single collective unit</span></span>
<span id="cb121-2"><a href="modeling.html#cb121-2" aria-hidden="true" tabindex="-1"></a>final_ins_boost_fit <span class="ot">&lt;-</span> final_ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb121-3"><a href="modeling.html#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull_workflow_fit</span>()</span>
<span id="cb121-4"><a href="modeling.html#cb121-4" aria-hidden="true" tabindex="-1"></a>final_ins_boost_fit<span class="sc">$</span>fit <span class="sc">%&gt;%</span></span>
<span id="cb121-5"><a href="modeling.html#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xgb.plot.multi.trees</span>(<span class="at">render =</span> T)</span>
<span id="cb121-6"><a href="modeling.html#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="co"># output as figure below as this returns a htmlwidget which is not that</span></span>
<span id="cb121-7"><a href="modeling.html#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="co"># intuitively handled by latex (pdf output)</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:insmultitree"></span>
<img src="_pictures/ins_multitree_xgb.png" alt="Visualization of the final ensemble of trees as a single collective unit." width="70%" />
<p class="caption">
Figure 5.10: Visualization of the final ensemble of trees as a single collective unit.
</p>
</div>
<p>It is quite interesting to see that most of the time the smoker feature was used just once in the first node but not multiple times. This suggests a quite linear influence of smokers and of course the binary character of the feature can support this behavior. Age on the other hand is represented in multiple deephts with high importance which suggests a non-linear influence which was also visible during the EDA. Interestingly the children variable for example mostly is used at depth 3 for a split.</p>
<p>Which model performed the best on the test data set is the next interesting question. The results can be viewed below in tabular and graphical form.</p>
<table>
<caption><span id="tab:perfIns">Table 5.2: </span>Performance on the test data</caption>
<thead>
<tr class="header">
<th align="left">model</th>
<th align="right">mae</th>
<th align="right">rmse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">boost_pred</td>
<td align="right">0.0849</td>
<td align="right">0.1581</td>
</tr>
<tr class="even">
<td align="left">rf_pred</td>
<td align="right">0.0820</td>
<td align="right">0.1586</td>
</tr>
<tr class="odd">
<td align="left">baseline_lm</td>
<td align="right">0.1171</td>
<td align="right">0.1877</td>
</tr>
<tr class="even">
<td align="left">intercept_pred</td>
<td align="right">0.3227</td>
<td align="right">0.4012</td>
</tr>
</tbody>
</table>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-106-1.png" width="672" /></p>
<p>Once without the intercept only model.</p>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-107-1.png" width="672" /></p>
<p>So overall the XGBoost model again delivered the best performance on the test data set, but again not by a huge margin. The baseline linear model that takes all features without interactions into account also goes a long way and the performance w.r.t. the RMSE metric is even comparable to the Random forest model. Whether the rather small difference in performance is worth considering such a model is of course up to the use case. Again the XGBoost model displayed that it reaches a very competitive performance with minimal pre-processing, integrated feature selection and in this case the computational effort was quite small. The major pros and cons of the tree-based gradient boosting models will be shortly reviewed in the next and final section.</p>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body">
<div id="ref-HandsOnMLwithR" class="csl-entry">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline"><span class="smallcaps">Boehmke</span>, B. and <span class="smallcaps">Greenwell</span>, B. (2019). <em>Hands-on machine learning with r</em>.</div>
</div>
<div id="ref-xgboost_package" class="csl-entry">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline"><span class="smallcaps">Chen</span>, T., <span class="smallcaps">He</span>, T., <span class="smallcaps">Benesty</span>, M., <span class="smallcaps">Khotilovich</span>, V., <span class="smallcaps">Tang</span>, Y., <span class="smallcaps">Cho</span>, H., <span class="smallcaps">Chen</span>, K., <span class="smallcaps">Mitchell</span>, R., <span class="smallcaps">Cano</span>, I., <span class="smallcaps">Zhou</span>, T., <span class="smallcaps">Li</span>, M., <span class="smallcaps">Xie</span>, J., <span class="smallcaps">Lin</span>, M., <span class="smallcaps">Geng</span>, Y. and <span class="smallcaps">Li</span>, Y. (2021). <em>Xgboost: Extreme gradient boosting</em>.</div>
</div>
<div id="ref-ranger_package" class="csl-entry">
<div class="csl-left-margin">[16] </div><div class="csl-right-inline"><span class="smallcaps">Wright</span>, M. N. and <span class="smallcaps">Ziegler</span>, A. (2017). <span class="nocase">ranger</span>: A fast implementation of random forests for high dimensional data in <span>C++</span> and <span>R</span>. <em>Journal of Statistical Software</em> <strong>77</strong> 1–7.</div>
</div>
<div id="ref-vipPack" class="csl-entry">
<div class="csl-left-margin">[17] </div><div class="csl-right-inline"><span class="smallcaps">Greenwell</span>, B. M. and <span class="smallcaps">Boehmke</span>, B. C. (2020). Variable importance plots—an introduction to the vip package. <em>The R Journal</em> <strong>12</strong> 343–66.</div>
</div>
<div id="ref-doParallel_package" class="csl-entry">
<div class="csl-left-margin">[18] </div><div class="csl-right-inline"><span class="smallcaps">Corporation</span>, M. and <span class="smallcaps">Weston</span>, S. (2019). <em>doParallel: Foreach parallel adaptor for the ’parallel’ package</em>.</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="eda.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="conclusion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["boosting_methods.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
