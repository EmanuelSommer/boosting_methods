<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Let’s boost the models | Boosting methods: Theory and application in R</title>
  <meta name="description" content="Boosting methods: Theory and Application in R (XGBoost)" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Let’s boost the models | Boosting methods: Theory and application in R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Boosting methods: Theory and Application in R (XGBoost)" />
  <meta name="github-repo" content="EmanuelSommer/boosting_methods" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Let’s boost the models | Boosting methods: Theory and application in R" />
  
  <meta name="twitter:description" content="Boosting methods: Theory and Application in R (XGBoost)" />
  

<meta name="author" content="Emanuel Sommer" />


<meta name="date" content="2021-05-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="eda.html"/>
<link rel="next" href="conclusion.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Boosting methods</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="theory.html"><a href="theory.html"><i class="fa fa-check"></i><b>3</b> Theory</a>
<ul>
<li class="chapter" data-level="3.1" data-path="theory.html"><a href="theory.html#the-powerful-idea-of-gradient-boosting"><i class="fa fa-check"></i><b>3.1</b> The powerful idea of gradient boosting</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="theory.html"><a href="theory.html#forward-stagewise-additive-modeling"><i class="fa fa-check"></i><b>3.1.1</b> Forward Stagewise Additive Modeling</a></li>
<li class="chapter" data-level="3.1.2" data-path="theory.html"><a href="theory.html#robust-loss-functions-for-regression"><i class="fa fa-check"></i><b>3.1.2</b> Robust loss functions for regression</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="theory.html"><a href="theory.html#general-gradient-tree-boosting"><i class="fa fa-check"></i><b>3.2</b> General gradient tree boosting</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="theory.html"><a href="theory.html#numOpt"><i class="fa fa-check"></i><b>3.2.1</b> Numerical optimization</a></li>
<li class="chapter" data-level="3.2.2" data-path="theory.html"><a href="theory.html#single-tree-depth"><i class="fa fa-check"></i><b>3.2.2</b> Single tree depth</a></li>
<li class="chapter" data-level="3.2.3" data-path="theory.html"><a href="theory.html#combOver"><i class="fa fa-check"></i><b>3.2.3</b> Combat overfitting</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="theory.html"><a href="theory.html#xgboost-a-highly-efficient-implementation"><i class="fa fa-check"></i><b>3.3</b> XGBoost a highly efficient implementation</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="theory.html"><a href="theory.html#regularized-loss"><i class="fa fa-check"></i><b>3.3.1</b> Regularized loss</a></li>
<li class="chapter" data-level="3.3.2" data-path="theory.html"><a href="theory.html#shrinkage-and-subsampling"><i class="fa fa-check"></i><b>3.3.2</b> Shrinkage and subsampling</a></li>
<li class="chapter" data-level="3.3.3" data-path="theory.html"><a href="theory.html#even-more-tweaks"><i class="fa fa-check"></i><b>3.3.3</b> Even more tweaks</a></li>
<li class="chapter" data-level="3.3.4" data-path="theory.html"><a href="theory.html#hyperparameters-overview"><i class="fa fa-check"></i><b>3.3.4</b> Hyperparameters overview</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="eda.html"><a href="eda.html"><i class="fa fa-check"></i><b>4</b> Explore the data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="eda.html"><a href="eda.html#burnout-data"><i class="fa fa-check"></i><b>4.1</b> Burnout data</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="eda.html"><a href="eda.html#train-test-split"><i class="fa fa-check"></i><b>4.1.1</b> Train-test split</a></li>
<li class="chapter" data-level="4.1.2" data-path="eda.html"><a href="eda.html#quick-general-overview"><i class="fa fa-check"></i><b>4.1.2</b> Quick general overview</a></li>
<li class="chapter" data-level="4.1.3" data-path="eda.html"><a href="eda.html#what-about-the-outcome-variable"><i class="fa fa-check"></i><b>4.1.3</b> What about the outcome variable?</a></li>
<li class="chapter" data-level="4.1.4" data-path="eda.html"><a href="eda.html#distribution-and-main-effects-of-the-predictors"><i class="fa fa-check"></i><b>4.1.4</b> Distribution and main effects of the predictors</a></li>
<li class="chapter" data-level="4.1.5" data-path="eda.html"><a href="eda.html#relationships-between-the-predictors"><i class="fa fa-check"></i><b>4.1.5</b> Relationships between the predictors</a></li>
<li class="chapter" data-level="4.1.6" data-path="eda.html"><a href="eda.html#some-feature-engineering"><i class="fa fa-check"></i><b>4.1.6</b> Some feature engineering</a></li>
<li class="chapter" data-level="4.1.7" data-path="eda.html"><a href="eda.html#create-the-recipe"><i class="fa fa-check"></i><b>4.1.7</b> Create the recipe</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="eda.html"><a href="eda.html#insurence-data"><i class="fa fa-check"></i><b>4.2</b> Insurence data</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="eda.html"><a href="eda.html#train-test-split-1"><i class="fa fa-check"></i><b>4.2.1</b> Train-test split</a></li>
<li class="chapter" data-level="4.2.2" data-path="eda.html"><a href="eda.html#a-general-overview"><i class="fa fa-check"></i><b>4.2.2</b> A general overview</a></li>
<li class="chapter" data-level="4.2.3" data-path="eda.html"><a href="eda.html#what-about-the-outcome"><i class="fa fa-check"></i><b>4.2.3</b> What about the outcome?</a></li>
<li class="chapter" data-level="4.2.4" data-path="eda.html"><a href="eda.html#distribution-and-main-effects-of-the-predictors-1"><i class="fa fa-check"></i><b>4.2.4</b> Distribution and main effects of the predictors</a></li>
<li class="chapter" data-level="4.2.5" data-path="eda.html"><a href="eda.html#relationships-between-the-predictors-1"><i class="fa fa-check"></i><b>4.2.5</b> Relationships between the predictors</a></li>
<li class="chapter" data-level="4.2.6" data-path="eda.html"><a href="eda.html#create-the-recipe-1"><i class="fa fa-check"></i><b>4.2.6</b> Create the recipe</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>5</b> Let’s boost the models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="modeling.html"><a href="modeling.html#burnout-data-1"><i class="fa fa-check"></i><b>5.1</b> Burnout data</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="modeling.html"><a href="modeling.html#baseline-models"><i class="fa fa-check"></i><b>5.1.1</b> Baseline models</a></li>
<li class="chapter" data-level="5.1.2" data-path="modeling.html"><a href="modeling.html#model-specification"><i class="fa fa-check"></i><b>5.1.2</b> Model specification</a></li>
<li class="chapter" data-level="5.1.3" data-path="modeling.html"><a href="modeling.html#tuning"><i class="fa fa-check"></i><b>5.1.3</b> Tuning</a></li>
<li class="chapter" data-level="5.1.4" data-path="modeling.html"><a href="modeling.html#evaluate-and-understand-the-model"><i class="fa fa-check"></i><b>5.1.4</b> Evaluate and understand the model</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="modeling.html"><a href="modeling.html#insurance-data"><i class="fa fa-check"></i><b>5.2</b> Insurance data</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="modeling.html"><a href="modeling.html#baseline-models-1"><i class="fa fa-check"></i><b>5.2.1</b> Baseline models</a></li>
<li class="chapter" data-level="5.2.2" data-path="modeling.html"><a href="modeling.html#model-specification-1"><i class="fa fa-check"></i><b>5.2.2</b> Model specification</a></li>
<li class="chapter" data-level="5.2.3" data-path="modeling.html"><a href="modeling.html#tuning-1"><i class="fa fa-check"></i><b>5.2.3</b> Tuning</a></li>
<li class="chapter" data-level="5.2.4" data-path="modeling.html"><a href="modeling.html#evaluate-and-understand-the-model-1"><i class="fa fa-check"></i><b>5.2.4</b> Evaluate and understand the model</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>6</b> Conclusion</a></li>
<li class="chapter" data-level="7" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>7</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Boosting methods: Theory and application in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="modeling" class="section level1" number="5">
<h1><span class="header-section-number">Chapter 5</span> Let’s boost the models</h1>
<p>Beside the XGBoost model also a random forest model will be fitted here for comparison. The whole modeling approach and procedure is closely following the principles that are outlined in the great book <em>Tidy modeling with R</em> by Max Kuhn and Julia Silge.</p>
<p>For the modeling three additional packages are required.<span class="citation">[<a href="references.html#ref-vipPack" role="doc-biblioref">16</a>]</span></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="modeling.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost) <span class="co"># for the xgboost model</span></span>
<span id="cb41-2"><a href="modeling.html#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger) <span class="co"># for the random forest model</span></span>
<span id="cb41-3"><a href="modeling.html#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># + the vip package but it will not be loaded into</span></span>
<span id="cb41-4"><a href="modeling.html#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the namespace</span></span></code></pre></div>
<p>For parallel computations the <code>doParallel</code> package is used.<span class="citation">[<a href="references.html#ref-doParallel_package" role="doc-biblioref">17</a>]</span>
This is most useful for the tuning part.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="modeling.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb42-2"><a href="modeling.html#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="modeling.html#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a cluster object and then register: </span></span>
<span id="cb42-4"><a href="modeling.html#cb42-4" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makePSOCKcluster</span>(<span class="dv">2</span>)</span>
<span id="cb42-5"><a href="modeling.html#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span></code></pre></div>
<p>First one has to set a <strong>metric</strong> for the evaluation of the final performance. As one knows from the EDA that not a lot of outliers are present in the data one can leave the default for XGBoost as the optimization metric for regression which is the root mean squared error (RMSE) which basically corresponds to the <span class="math inline">\(L_2\)</span> loss. Besides also the mean average error (MAE) which is kind of the <span class="math inline">\(L_1\)</span> norm will be covered but the optimization and tuning will focus on the RMSE.</p>
<div id="burnout-data-1" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Burnout data</h2>
<div id="baseline-models" class="section level3" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Baseline models</h3>
<p>The first thing is to set up the trivial <strong>baseline models</strong>.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="modeling.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the trivial intercept only model:</span></span>
<span id="cb43-2"><a href="modeling.html#cb43-2" aria-hidden="true" tabindex="-1"></a>bout_predict_trivial_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(new_data) {</span>
<span id="cb43-3"><a href="modeling.html#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rep</span>(<span class="fu">mean</span>(burnout_train<span class="sc">$</span>burn_rate), <span class="fu">nrow</span>(new_data))</span>
<span id="cb43-4"><a href="modeling.html#cb43-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-5"><a href="modeling.html#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="modeling.html#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the trivial scoring of mental fatigue score (if missing intercept model)</span></span>
<span id="cb43-7"><a href="modeling.html#cb43-7" aria-hidden="true" tabindex="-1"></a>bout_predict_trivial_mfs <span class="ot">&lt;-</span> <span class="cf">function</span>(new_data) {</span>
<span id="cb43-8"><a href="modeling.html#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># these two scoring parameters are correspondint to the </span></span>
<span id="cb43-9"><a href="modeling.html#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simple linear regression model containing only one predictor</span></span>
<span id="cb43-10"><a href="modeling.html#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i.e. mfs</span></span>
<span id="cb43-11"><a href="modeling.html#cb43-11" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> new_data[[<span class="st">&quot;mental_fatigue_score&quot;</span>]] <span class="sc">*</span> <span class="fl">0.097</span> <span class="sc">-</span> <span class="fl">0.1</span></span>
<span id="cb43-12"><a href="modeling.html#cb43-12" aria-hidden="true" tabindex="-1"></a>  pred[<span class="fu">is.na</span>(pred)] <span class="ot">&lt;-</span> <span class="fu">mean</span>(burnout_train<span class="sc">$</span>burn_rate)</span>
<span id="cb43-13"><a href="modeling.html#cb43-13" aria-hidden="true" tabindex="-1"></a>  pred</span>
<span id="cb43-14"><a href="modeling.html#cb43-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The predictions of these baseline models on the test data set will be compared with the predictions of the tree-based models that will be constructed.</p>
</div>
<div id="model-specification" class="section level3" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Model specification</h3>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="modeling.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Models:</span></span>
<span id="cb44-2"><a href="modeling.html#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="modeling.html#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Random forest model for comparison</span></span>
<span id="cb44-4"><a href="modeling.html#cb44-4" aria-hidden="true" tabindex="-1"></a>bout_rf_model <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb44-5"><a href="modeling.html#cb44-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mtry =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb44-6"><a href="modeling.html#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;ranger&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-7"><a href="modeling.html#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span>
<span id="cb44-8"><a href="modeling.html#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="modeling.html#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co"># XGBoost model</span></span>
<span id="cb44-10"><a href="modeling.html#cb44-10" aria-hidden="true" tabindex="-1"></a>bout_boost_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb44-11"><a href="modeling.html#cb44-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb44-12"><a href="modeling.html#cb44-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb44-13"><a href="modeling.html#cb44-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb44-14"><a href="modeling.html#cb44-14" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb44-15"><a href="modeling.html#cb44-15" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample_size =</span> <span class="fu">tune</span>(),</span>
<span id="cb44-16"><a href="modeling.html#cb44-16" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stop_iter =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-17"><a href="modeling.html#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-18"><a href="modeling.html#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="modeling.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Workflows: model + recipe</span></span>
<span id="cb45-2"><a href="modeling.html#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="modeling.html#cb45-3" aria-hidden="true" tabindex="-1"></a>bout_rf_wflow <span class="ot">&lt;-</span></span>
<span id="cb45-4"><a href="modeling.html#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-5"><a href="modeling.html#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(bout_rf_model) <span class="sc">%&gt;%</span></span>
<span id="cb45-6"><a href="modeling.html#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(burnout_rec_rf)</span>
<span id="cb45-7"><a href="modeling.html#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="modeling.html#cb45-8" aria-hidden="true" tabindex="-1"></a>bout_boost_wflow <span class="ot">&lt;-</span></span>
<span id="cb45-9"><a href="modeling.html#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-10"><a href="modeling.html#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(bout_boost_model) <span class="sc">%&gt;%</span></span>
<span id="cb45-11"><a href="modeling.html#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(burnout_rec_boost)</span></code></pre></div>
</div>
<div id="tuning" class="section level3" number="5.1.3">
<h3><span class="header-section-number">5.1.3</span> Tuning</h3>
<p>For the hyperparameter tuning one needs validation sets to monitor the models on unseen data. To do this 5-fold cross validation (CV) is used here.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="modeling.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Resampling object</span></span>
<span id="cb46-2"><a href="modeling.html#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb46-3"><a href="modeling.html#cb46-3" aria-hidden="true" tabindex="-1"></a>burnout_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(burnout_train, <span class="at">v =</span> <span class="dv">5</span>)</span></code></pre></div>
<p>Now adjust or check the hyperparameter ranges that the tuning will use. First the Random forest model.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="modeling.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Have a look at the hyperparameters that have to be tuned and finalize them</span></span>
<span id="cb47-2"><a href="modeling.html#cb47-2" aria-hidden="true" tabindex="-1"></a>bout_rf_params <span class="ot">&lt;-</span> bout_rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="modeling.html#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>()</span>
<span id="cb47-4"><a href="modeling.html#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="modeling.html#cb47-5" aria-hidden="true" tabindex="-1"></a>bout_rf_params </span></code></pre></div>
<pre><code>## Collection of 2 parameters for tuning
## 
##  identifier  type    object
##        mtry  mtry nparam[?]
##       trees trees nparam[+]
## 
## Model parameters needing finalization:
##    # Randomly Selected Predictors (&#39;mtry&#39;)
## 
## See `?dials::finalize` or `?dials::update.parameters` for more information.</code></pre>
<p>This shows that the <code>mtry</code> hyperparameter has to be adjusted depending on the data. Moreover with the <code>dials::update</code> function one can manually set the ranges that should be used for tuning.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="modeling.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># default range for tuning is 1 up to 2000 for the trees argument</span></span>
<span id="cb49-2"><a href="modeling.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># set the lower bound of the range to 100. Then finalize the</span></span>
<span id="cb49-3"><a href="modeling.html#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters using the training data.</span></span>
<span id="cb49-4"><a href="modeling.html#cb49-4" aria-hidden="true" tabindex="-1"></a>bout_rf_params <span class="ot">&lt;-</span> bout_rf_params <span class="sc">%&gt;%</span></span>
<span id="cb49-5"><a href="modeling.html#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">trees =</span> <span class="fu">trees</span>(<span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">2000</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb49-6"><a href="modeling.html#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(burnout_train)</span>
<span id="cb49-7"><a href="modeling.html#cb49-7" aria-hidden="true" tabindex="-1"></a>bout_rf_params</span></code></pre></div>
<pre><code>## Collection of 2 parameters for tuning
## 
##  identifier  type    object
##        mtry  mtry nparam[+]
##       trees trees nparam[+]</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="modeling.html#cb51-1" aria-hidden="true" tabindex="-1"></a>bout_rf_params <span class="sc">%&gt;%</span> <span class="fu">pull_dials_object</span>(<span class="st">&quot;mtry&quot;</span>)</span></code></pre></div>
<pre><code>## # Randomly Selected Predictors (quantitative)
## Range: [1, 9]</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="modeling.html#cb53-1" aria-hidden="true" tabindex="-1"></a>bout_rf_params <span class="sc">%&gt;%</span> <span class="fu">pull_dials_object</span>(<span class="st">&quot;trees&quot;</span>)</span></code></pre></div>
<pre><code>## # Trees (quantitative)
## Range: [100, 2000]</code></pre>
<p>Now this parameter object is ready for tuning and the same steps have to be performed on the boosting workflow.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="modeling.html#cb55-1" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="modeling.html#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>()</span>
<span id="cb55-3"><a href="modeling.html#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="modeling.html#cb55-4" aria-hidden="true" tabindex="-1"></a>bout_boost_params </span></code></pre></div>
<pre><code>## Collection of 6 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[?]
##           trees          trees nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]
## 
## Model parameters needing finalization:
##    # Randomly Selected Predictors (&#39;mtry&#39;)
## 
## See `?dials::finalize` or `?dials::update.parameters` for more information.</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="modeling.html#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first a look at the default ranges</span></span>
<span id="cb57-2"><a href="modeling.html#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">trees</span>()</span></code></pre></div>
<pre><code>## # Trees (quantitative)
## Range: [1, 2000]</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="modeling.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tree_depth</span>()</span></code></pre></div>
<pre><code>## Tree Depth (quantitative)
## Range: [1, 15]</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="modeling.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">learn_rate</span>()</span></code></pre></div>
<pre><code>## Learning Rate (quantitative)
## Transformer:  log-10 
## Range (transformed scale): [-10, -1]</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="modeling.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loss_reduction</span>()</span></code></pre></div>
<pre><code>## Minimum Loss Reduction (quantitative)
## Transformer:  log-10 
## Range (transformed scale): [-10, 1.5]</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="modeling.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sample_size</span>()</span></code></pre></div>
<pre><code>## # Observations Sampled (quantitative)
## Range: [?, ?]</code></pre>
<p>So <code>sample_size</code> must also be finalized. Again the lower bound on the number of trees will be raised to 100. The other scales are really sensible and will be left as is.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="modeling.html#cb67-1" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="ot">&lt;-</span> bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="modeling.html#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">trees =</span> <span class="fu">trees</span>(<span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">2000</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="modeling.html#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(burnout_train)</span>
<span id="cb67-4"><a href="modeling.html#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="modeling.html#cb67-5" aria-hidden="true" tabindex="-1"></a>bout_boost_params</span></code></pre></div>
<pre><code>## Collection of 6 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[+]
##           trees          trees nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="modeling.html#cb69-1" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb69-2"><a href="modeling.html#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull_dials_object</span>(<span class="st">&quot;sample_size&quot;</span>)</span></code></pre></div>
<pre><code>## Proportion Observations Sampled (quantitative)
## Range: [0.1, 1]</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="modeling.html#cb71-1" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb71-2"><a href="modeling.html#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull_dials_object</span>(<span class="st">&quot;mtry&quot;</span>)</span></code></pre></div>
<pre><code>## # Randomly Selected Predictors (quantitative)
## Range: [1, 9]</code></pre>
<p>Now also this parameter object is ready to be used. The next step is to define the metrics used for evaluation while tuning.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="modeling.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define a metrics set used for evaluation of the hyperparameters</span></span>
<span id="cb73-2"><a href="modeling.html#cb73-2" aria-hidden="true" tabindex="-1"></a>regr_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(rmse, mae)</span></code></pre></div>
<p>Now the actual tuning begins. The models will be tuned by a space filling grid search. As one has defined ranges for each parameter one can then use different algorithms to construct a grid of combinations of parameter values that tries to best fill the defined ranges by random sampling also in a high dimensional setting. In the following the function <code>tune::grid_latin_hypercube</code> is used for this. So basically one tries out all hyperparameter values for each fold and saves the performance of the performance metrics on the hold out fold. These metrics are then aggregated for each combination and with the resulting estimates of performance one can choose the final set of hyperparameters. The more hyperparameters the model has the more tuning rounds might needed to refine the grid. Besides the classical grid search there are also iterative methods for tuning. These are mainly good to tune a single hyperparameter at once and not for a bunch of them simultaneously. They will not be used in the following.</p>
<p>The <strong>random forest model</strong> goes first with the tuning.</p>
<p>Here there are as seen above only two hyperparameters to be tuned thus 30 combinations should suffice.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="modeling.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 30 minutes</span></span>
<span id="cb74-2"><a href="modeling.html#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb74-3"><a href="modeling.html#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb74-4"><a href="modeling.html#cb74-4" aria-hidden="true" tabindex="-1"></a>  bout_rf_tune <span class="ot">&lt;-</span> bout_rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb74-5"><a href="modeling.html#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb74-6"><a href="modeling.html#cb74-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  burnout_folds,</span>
<span id="cb74-7"><a href="modeling.html#cb74-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> bout_rf_params <span class="sc">%&gt;%</span></span>
<span id="cb74-8"><a href="modeling.html#cb74-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(<span class="at">size =</span> <span class="dv">30</span>, <span class="at">original =</span> <span class="cn">FALSE</span>),</span>
<span id="cb74-9"><a href="modeling.html#cb74-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb74-10"><a href="modeling.html#cb74-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-11"><a href="modeling.html#cb74-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb74-12"><a href="modeling.html#cb74-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-13"><a href="modeling.html#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="co"># visualization of the tuning results (snapshot of the output below)</span></span>
<span id="cb74-14"><a href="modeling.html#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bout_rf_tune) <span class="sc">+</span> <span class="fu">theme_light</span>()</span>
<span id="cb74-15"><a href="modeling.html#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="co"># this functions shows the best combinations wrt the rmse metric of all the</span></span>
<span id="cb74-16"><a href="modeling.html#cb74-16" aria-hidden="true" tabindex="-1"></a><span class="co"># combinations in the grid</span></span>
<span id="cb74-17"><a href="modeling.html#cb74-17" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_rf_tune, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:rfburntuneplot"></span>
<img src="_pictures/rf_burn_tune_plot.png" alt="Result of a spacefilling grid search for the random forest model." width="70%" />
<p class="caption">
Figure 5.1: Result of a spacefilling grid search for the random forest model.
</p>
</div>
<p>The visualization alongside the best performing results suggest that a value of <code>mtry</code>of 3 and 1000 <code>trees</code> should give good results. Thus one can finalize and fit this model.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="modeling.html#cb75-1" aria-hidden="true" tabindex="-1"></a>final_bout_rf_wflow <span class="ot">&lt;-</span> </span>
<span id="cb75-2"><a href="modeling.html#cb75-2" aria-hidden="true" tabindex="-1"></a>  bout_rf_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb75-3"><a href="modeling.html#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">tibble</span>(</span>
<span id="cb75-4"><a href="modeling.html#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="dv">1000</span>,</span>
<span id="cb75-5"><a href="modeling.html#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="dv">3</span></span>
<span id="cb75-6"><a href="modeling.html#cb75-6" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb75-7"><a href="modeling.html#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(burnout_train)</span></code></pre></div>
<p>Now the <strong>boosting model</strong>.</p>
<p>First tune only the number of trees in order to detect a number of
trees that is ‘large enough.’ Then tune the tree specific arguments.
If one tunes all parameters at the same time the grid grows to large. Moreover a tuning of the trees argument could encourage overfitting.</p>
<p>The first tuning round:</p>
<p>To display the discussed impact of different maximum tree depths the first grid search for a good number of trees will besides the kind of standard value 6 also be performed for regression stumps i.e. a value of 1 for the maximum tree depth.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="modeling.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tuning grid just for the #trees one with max tree depth 6 and one with</span></span>
<span id="cb76-2"><a href="modeling.html#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co"># only stumps for comparison</span></span>
<span id="cb76-3"><a href="modeling.html#cb76-3" aria-hidden="true" tabindex="-1"></a>first_grid_boost_burn_depth6 <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb76-4"><a href="modeling.html#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">250</span>, <span class="dv">2000</span>, <span class="dv">250</span>),</span>
<span id="cb76-5"><a href="modeling.html#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">9</span>,</span>
<span id="cb76-6"><a href="modeling.html#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">6</span>,</span>
<span id="cb76-7"><a href="modeling.html#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.000001</span>,</span>
<span id="cb76-8"><a href="modeling.html#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb76-9"><a href="modeling.html#cb76-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb76-10"><a href="modeling.html#cb76-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-11"><a href="modeling.html#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="modeling.html#cb76-12" aria-hidden="true" tabindex="-1"></a>first_grid_boost_burn_stumps <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb76-13"><a href="modeling.html#cb76-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">250</span>, <span class="dv">2000</span>, <span class="dv">250</span>),</span>
<span id="cb76-14"><a href="modeling.html#cb76-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">9</span>,</span>
<span id="cb76-15"><a href="modeling.html#cb76-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">1</span>,</span>
<span id="cb76-16"><a href="modeling.html#cb76-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.000001</span>,</span>
<span id="cb76-17"><a href="modeling.html#cb76-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb76-18"><a href="modeling.html#cb76-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb76-19"><a href="modeling.html#cb76-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="modeling.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 1 minute</span></span>
<span id="cb77-2"><a href="modeling.html#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb77-3"><a href="modeling.html#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb77-4"><a href="modeling.html#cb77-4" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_first_stumps <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb77-5"><a href="modeling.html#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb77-6"><a href="modeling.html#cb77-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  burnout_folds,</span>
<span id="cb77-7"><a href="modeling.html#cb77-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> first_grid_boost_burn_stumps,</span>
<span id="cb77-8"><a href="modeling.html#cb77-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb77-9"><a href="modeling.html#cb77-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-10"><a href="modeling.html#cb77-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb77-11"><a href="modeling.html#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="modeling.html#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="modeling.html#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bout_boost_tune_first_stumps) <span class="sc">+</span> <span class="fu">theme_light</span>()</span>
<span id="cb77-14"><a href="modeling.html#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_first_stumps)</span></code></pre></div>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="modeling.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 1 minute</span></span>
<span id="cb78-2"><a href="modeling.html#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb78-3"><a href="modeling.html#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb78-4"><a href="modeling.html#cb78-4" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_first_depth6 <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb78-5"><a href="modeling.html#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb78-6"><a href="modeling.html#cb78-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  burnout_folds,</span>
<span id="cb78-7"><a href="modeling.html#cb78-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> first_grid_boost_burn_depth6,</span>
<span id="cb78-8"><a href="modeling.html#cb78-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb78-9"><a href="modeling.html#cb78-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb78-10"><a href="modeling.html#cb78-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb78-11"><a href="modeling.html#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="modeling.html#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot output is shown in the figure below</span></span>
<span id="cb78-13"><a href="modeling.html#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(bout_boost_tune_first_depth6) <span class="sc">+</span> <span class="fu">theme_light</span>()</span>
<span id="cb78-14"><a href="modeling.html#cb78-14" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_first_depth6)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:boostburntuneplot1"></span>
<img src="_pictures/burn_boost_tune_first.png" alt="Result of the first grid search for the XGBoost model (max depth 6)." width="70%" />
<p class="caption">
Figure 5.2: Result of the first grid search for the XGBoost model (max depth 6).
</p>
</div>
<p>Compare the two different first tuning rounds:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="modeling.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># output of this code shown in the figure below</span></span>
<span id="cb79-2"><a href="modeling.html#cb79-2" aria-hidden="true" tabindex="-1"></a>bout_boost_tune_first_stumps <span class="sc">%&gt;%</span></span>
<span id="cb79-3"><a href="modeling.html#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb79-4"><a href="modeling.html#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb79-5"><a href="modeling.html#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb79-6"><a href="modeling.html#cb79-6" aria-hidden="true" tabindex="-1"></a>    bout_boost_tune_first_depth6 <span class="sc">%&gt;%</span></span>
<span id="cb79-7"><a href="modeling.html#cb79-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb79-8"><a href="modeling.html#cb79-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="dv">6</span>)</span>
<span id="cb79-9"><a href="modeling.html#cb79-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb79-10"><a href="modeling.html#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> trees, <span class="at">y =</span> mean, <span class="at">col =</span> <span class="fu">factor</span>(tree_depth))) <span class="sc">+</span></span>
<span id="cb79-11"><a href="modeling.html#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb79-12"><a href="modeling.html#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb79-13"><a href="modeling.html#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb79-14"><a href="modeling.html#cb79-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">col =</span> <span class="st">&quot;Max tree depth&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Number of trees&quot;</span>,</span>
<span id="cb79-15"><a href="modeling.html#cb79-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb79-16"><a href="modeling.html#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;C&quot;</span>) <span class="sc">+</span></span>
<span id="cb79-17"><a href="modeling.html#cb79-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric) <span class="sc">+</span></span>
<span id="cb79-18"><a href="modeling.html#cb79-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:bouttuningstumpsVs6"></span>
<img src="_pictures/bout_tuning_stumpsVs6.png" alt="Comparison of the initial grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates." width="70%" />
<p class="caption">
Figure 5.3: Comparison of the initial grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates.
</p>
</div>
<p>This shows that the model with just stumps converges much faster or may even never reach the low level of when using deeper trees. One reason for this could be that these stumps do not account for interactions and of course the same number of deep trees encode much more information than the same number of stumps.</p>
<p>So 1500 trees should suffice here. Thus the workflow and model will be adjusted accordingly.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="modeling.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fix the number of trees by redefining the boosted model with a </span></span>
<span id="cb80-2"><a href="modeling.html#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed number of trees.</span></span>
<span id="cb80-3"><a href="modeling.html#cb80-3" aria-hidden="true" tabindex="-1"></a>bout_boost_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">1500</span>,</span>
<span id="cb80-4"><a href="modeling.html#cb80-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb80-5"><a href="modeling.html#cb80-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb80-6"><a href="modeling.html#cb80-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb80-7"><a href="modeling.html#cb80-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb80-8"><a href="modeling.html#cb80-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample_size =</span> <span class="fu">tune</span>(),</span>
<span id="cb80-9"><a href="modeling.html#cb80-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stop_iter =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-10"><a href="modeling.html#cb80-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb80-11"><a href="modeling.html#cb80-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span>
<span id="cb80-12"><a href="modeling.html#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="modeling.html#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="co"># update the workflow</span></span>
<span id="cb80-14"><a href="modeling.html#cb80-14" aria-hidden="true" tabindex="-1"></a>bout_boost_wflow <span class="ot">&lt;-</span></span>
<span id="cb80-15"><a href="modeling.html#cb80-15" aria-hidden="true" tabindex="-1"></a>  bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb80-16"><a href="modeling.html#cb80-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(bout_boost_model)</span>
<span id="cb80-17"><a href="modeling.html#cb80-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-18"><a href="modeling.html#cb80-18" aria-hidden="true" tabindex="-1"></a>bout_boost_params <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb80-19"><a href="modeling.html#cb80-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-20"><a href="modeling.html#cb80-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(burnout_train)</span>
<span id="cb80-21"><a href="modeling.html#cb80-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-22"><a href="modeling.html#cb80-22" aria-hidden="true" tabindex="-1"></a><span class="co"># reduced hyperparameter space</span></span>
<span id="cb80-23"><a href="modeling.html#cb80-23" aria-hidden="true" tabindex="-1"></a>bout_boost_params</span></code></pre></div>
<pre><code>## Collection of 5 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]</code></pre>
<p>Now perform the first major grid search over all the other hyperparameters and the second one overall.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="modeling.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now tune all the remaining hyperparameters with a large space filling grid</span></span>
<span id="cb82-2"><a href="modeling.html#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="modeling.html#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 1.5 hours</span></span>
<span id="cb82-4"><a href="modeling.html#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb82-5"><a href="modeling.html#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb82-6"><a href="modeling.html#cb82-6" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_second <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb82-7"><a href="modeling.html#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb82-8"><a href="modeling.html#cb82-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> burnout_folds,</span>
<span id="cb82-9"><a href="modeling.html#cb82-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb82-10"><a href="modeling.html#cb82-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb82-11"><a href="modeling.html#cb82-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">200</span>),</span>
<span id="cb82-12"><a href="modeling.html#cb82-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb82-13"><a href="modeling.html#cb82-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-14"><a href="modeling.html#cb82-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb82-15"><a href="modeling.html#cb82-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-16"><a href="modeling.html#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_second, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<p>Now refine the grid i.e. the parameter space according to the results of the last grid search and perform a third one.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="modeling.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now tune all the remaining hyperparameters with a refined space filling grid</span></span>
<span id="cb83-2"><a href="modeling.html#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="modeling.html#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 2 hours</span></span>
<span id="cb83-4"><a href="modeling.html#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb83-5"><a href="modeling.html#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb83-6"><a href="modeling.html#cb83-6" aria-hidden="true" tabindex="-1"></a>  bout_boost_tune_third <span class="ot">&lt;-</span> bout_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb83-7"><a href="modeling.html#cb83-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb83-8"><a href="modeling.html#cb83-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> burnout_folds,</span>
<span id="cb83-9"><a href="modeling.html#cb83-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> bout_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb83-10"><a href="modeling.html#cb83-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">update</span>(</span>
<span id="cb83-11"><a href="modeling.html#cb83-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">mtry =</span> <span class="fu">mtry</span>(<span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">9</span>)),</span>
<span id="cb83-12"><a href="modeling.html#cb83-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">tree_depth =</span> <span class="fu">tree_depth</span>(<span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>)),</span>
<span id="cb83-13"><a href="modeling.html#cb83-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">learn_rate =</span> <span class="fu">learn_rate</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.7</span>, <span class="sc">-</span><span class="fl">1.3</span>)),</span>
<span id="cb83-14"><a href="modeling.html#cb83-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">loss_reduction =</span> <span class="fu">loss_reduction</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">8</span>,<span class="sc">-</span><span class="dv">3</span>)),</span>
<span id="cb83-15"><a href="modeling.html#cb83-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">sample_size =</span> <span class="fu">sample_prop</span>(<span class="fu">c</span>(<span class="fl">0.4</span>, <span class="fl">0.9</span>))</span>
<span id="cb83-16"><a href="modeling.html#cb83-16" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb83-17"><a href="modeling.html#cb83-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb83-18"><a href="modeling.html#cb83-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">200</span>),</span>
<span id="cb83-19"><a href="modeling.html#cb83-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb83-20"><a href="modeling.html#cb83-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb83-21"><a href="modeling.html#cb83-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb83-22"><a href="modeling.html#cb83-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-23"><a href="modeling.html#cb83-23" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(bout_boost_tune_third, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<p>With this final grid search one is ready to finalize the model.</p>
<p>The results of the three grid searches suggest that no column-subsampling should be applied, the maximum tree depth should be 4, the learning rate should be small but not extremely small (<span class="math inline">\(\sim 0.02\)</span>), the loss reduction regularization effect is not needed here (very small) and the sample size for each tree should be set to 0.8.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="modeling.html#cb84-1" aria-hidden="true" tabindex="-1"></a>final_bout_boost_wflow <span class="ot">&lt;-</span> </span>
<span id="cb84-2"><a href="modeling.html#cb84-2" aria-hidden="true" tabindex="-1"></a>  bout_boost_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb84-3"><a href="modeling.html#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">tibble</span>(</span>
<span id="cb84-4"><a href="modeling.html#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="dv">9</span>,</span>
<span id="cb84-5"><a href="modeling.html#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="dv">4</span>,</span>
<span id="cb84-6"><a href="modeling.html#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> <span class="fl">0.02</span>,</span>
<span id="cb84-7"><a href="modeling.html#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss_reduction =</span> <span class="fl">0.0000003</span>,</span>
<span id="cb84-8"><a href="modeling.html#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="fl">0.8</span></span>
<span id="cb84-9"><a href="modeling.html#cb84-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb84-10"><a href="modeling.html#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(burnout_train)</span></code></pre></div>
</div>
<div id="evaluate-and-understand-the-model" class="section level3" number="5.1.4">
<h3><span class="header-section-number">5.1.4</span> Evaluate and understand the model</h3>
<p>First a visualization of the variable importance. The variable importance is calculated by measuring the frequency of appearance of each feature in the single trees.</p>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-189-1.png" width="672" /></p>
<p>This shows that indeed the <code>mental_fatigue_score</code> is the most influential predictor by far followed by the <code>ressource_allocation</code> and <code>designation</code> features. These results are not at all surprising as the EDA exactly came to these conclusions. Especially the very few appearances of the features connected to <code>company_type</code> and <code>date_of_joining</code> are most likely just some minor overfitting.</p>
<p>Now have a look at the performance of the boosting model w.r.t. missing values in the most influential variable.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="modeling.html#cb85-1" aria-hidden="true" tabindex="-1"></a>burnout_test <span class="sc">%&gt;%</span></span>
<span id="cb85-2"><a href="modeling.html#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">boost_pred =</span> <span class="fu">predict</span>(final_bout_boost_wflow,</span>
<span id="cb85-3"><a href="modeling.html#cb85-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">new_data =</span> .)[[<span class="st">&quot;.pred&quot;</span>]]) <span class="sc">%&gt;%</span></span>
<span id="cb85-4"><a href="modeling.html#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mental_fatigue_score)) <span class="sc">%&gt;%</span></span>
<span id="cb85-5"><a href="modeling.html#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> burn_rate, <span class="at">y =</span> boost_pred)) <span class="sc">+</span></span>
<span id="cb85-6"><a href="modeling.html#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="fu">plasma</span>(<span class="dv">1</span>), <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb85-7"><a href="modeling.html#cb85-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb85-8"><a href="modeling.html#cb85-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb85-9"><a href="modeling.html#cb85-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb85-10"><a href="modeling.html#cb85-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;XGBoost predictions&quot;</span>,</span>
<span id="cb85-11"><a href="modeling.html#cb85-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;True score&quot;</span>,</span>
<span id="cb85-12"><a href="modeling.html#cb85-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;XGBoost performance for non missing mental fatigue score&quot;</span>) <span class="sc">+</span></span>
<span id="cb85-13"><a href="modeling.html#cb85-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb85-14"><a href="modeling.html#cb85-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> ggtext<span class="sc">::</span><span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">11</span>))</span></code></pre></div>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-190-1.png" width="672" /></p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="modeling.html#cb86-1" aria-hidden="true" tabindex="-1"></a>burnout_test <span class="sc">%&gt;%</span></span>
<span id="cb86-2"><a href="modeling.html#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">boost_pred =</span> <span class="fu">predict</span>(final_bout_boost_wflow,</span>
<span id="cb86-3"><a href="modeling.html#cb86-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">new_data =</span> .)[[<span class="st">&quot;.pred&quot;</span>]]) <span class="sc">%&gt;%</span></span>
<span id="cb86-4"><a href="modeling.html#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(mental_fatigue_score)) <span class="sc">%&gt;%</span></span>
<span id="cb86-5"><a href="modeling.html#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> burn_rate, <span class="at">y =</span> boost_pred)) <span class="sc">+</span></span>
<span id="cb86-6"><a href="modeling.html#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="fu">plasma</span>(<span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb86-7"><a href="modeling.html#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb86-8"><a href="modeling.html#cb86-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb86-9"><a href="modeling.html#cb86-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb86-10"><a href="modeling.html#cb86-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;XGBoost predictions&quot;</span>,</span>
<span id="cb86-11"><a href="modeling.html#cb86-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;True score&quot;</span>,</span>
<span id="cb86-12"><a href="modeling.html#cb86-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;XGBoost performance for missing mental fatigue score&quot;</span>) <span class="sc">+</span></span>
<span id="cb86-13"><a href="modeling.html#cb86-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb86-14"><a href="modeling.html#cb86-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> ggtext<span class="sc">::</span><span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">11</span>))</span></code></pre></div>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-190-2.png" width="672" /></p>
<p>The performance for the missing values is indeed not that precise but still quite good. There is at least no huge outlier detectable here.</p>
<p>Now the really interesting part is which model performed the best on the test data set. The results can be viewed below in tabular and grapical form.</p>
<table>
<caption><span id="tab:perfBurn">Table 5.1: </span>Performance on the test data</caption>
<thead>
<tr class="header">
<th align="left">model</th>
<th align="right">mae</th>
<th align="right">rmse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">boost_pred</td>
<td align="right">0.0470</td>
<td align="right">0.0599</td>
</tr>
<tr class="even">
<td align="left">rf_pred</td>
<td align="right">0.0473</td>
<td align="right">0.0608</td>
</tr>
<tr class="odd">
<td align="left">mfs_scored_pred</td>
<td align="right">0.0624</td>
<td align="right">0.0851</td>
</tr>
<tr class="even">
<td align="left">intercept_pred</td>
<td align="right">0.1591</td>
<td align="right">0.1986</td>
</tr>
</tbody>
</table>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-191-1.png" width="672" /></p>
<p>It can be observed that already the really simple baseline model that just scales the mental fatigue score (so it reflects just a single linear influence) has a really low MAE and RMSE. Still both random forest as well as the boosting model can further improve this metric but the huge linear influence of the mental fatigue score obviously leaves not much room for improvement. By the way the simple linear model with just this one predictor has already an <span class="math inline">\(R^2\)</span> of more than 0.92. XGBoost manages to get a slightly better performance on the test data set but this would only be nice in a machine learning competition as in real life this difference would negligible. Actually in this use case for a real life application a very easy explainable linear model might be somewhat better than a complex model like XGBoost as the difference in performance is not too big. Nevertheless in my opinion the predictor <code>mental_fatigue_score</code> should be treated with extreme care as in a real life situation the collection of this score could be as costly or hard as the one of the outcome. There might be even latent variables that are highly linearly correlated to both scores. But this data was not intended to be used in a real life application but was shared at a machine learning competition and actually many of the best submissions there used XGBoost models.</p>
<p>This finishes the analysis of the burnout data set. But no worries there is still one data set and boosting model left to explore namely the insurance data set.</p>
</div>
</div>
<div id="insurance-data" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Insurance data</h2>
<div id="baseline-models-1" class="section level3" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Baseline models</h3>
<p>The first thing is to set up the trivial <strong>baseline models</strong>.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="modeling.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the trivial intercept only model:</span></span>
<span id="cb87-2"><a href="modeling.html#cb87-2" aria-hidden="true" tabindex="-1"></a>ins_predict_trivial_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(new_data) {</span>
<span id="cb87-3"><a href="modeling.html#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rep</span>(<span class="fu">mean</span>(ins_train<span class="sc">$</span>log10_charges), <span class="fu">nrow</span>(new_data))</span>
<span id="cb87-4"><a href="modeling.html#cb87-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-5"><a href="modeling.html#cb87-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-6"><a href="modeling.html#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the trivial linear model without any interactions (as we do not have </span></span>
<span id="cb87-7"><a href="modeling.html#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="co"># missing values does not have to be dealt with them)</span></span>
<span id="cb87-8"><a href="modeling.html#cb87-8" aria-hidden="true" tabindex="-1"></a>ins_baseline_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(log10_charges <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> bmi <span class="sc">+</span></span>
<span id="cb87-9"><a href="modeling.html#cb87-9" aria-hidden="true" tabindex="-1"></a>                        children <span class="sc">+</span> smoker <span class="sc">+</span> region,</span>
<span id="cb87-10"><a href="modeling.html#cb87-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ins_train <span class="sc">%&gt;%</span> </span>
<span id="cb87-11"><a href="modeling.html#cb87-11" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), as.factor)))</span>
<span id="cb87-12"><a href="modeling.html#cb87-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ins_baseline_lm)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = log10_charges ~ age + sex + bmi + children + smoker + 
##     region, data = ins_train %&gt;% mutate(across(where(is.character), 
##     as.factor)))
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.44965 -0.08961 -0.02153  0.02545  0.94160 
## 
## Coefficients:
##                   Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)      3.0621889  0.0356014  86.013  &lt; 2e-16 ***
## age              0.0152118  0.0004257  35.732  &lt; 2e-16 ***
## sexmale         -0.0311944  0.0120832  -2.582  0.00997 ** 
## bmi              0.0050224  0.0010256   4.897 1.12e-06 ***
## children         0.0449393  0.0049320   9.112  &lt; 2e-16 ***
## smokeryes        0.6692558  0.0151680  44.123  &lt; 2e-16 ***
## regionnorthwest -0.0222316  0.0174865  -1.271  0.20388    
## regionsoutheast -0.0562475  0.0173409  -3.244  0.00122 ** 
## regionsouthwest -0.0505708  0.0172173  -2.937  0.00338 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.1963 on 1062 degrees of freedom
## Multiple R-squared:  0.7623, Adjusted R-squared:  0.7605 
## F-statistic: 425.6 on 8 and 1062 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>The predictions of these baseline models on the test data set will be compared with the predictions of the tree-based models that will be constructed.</p>
</div>
<div id="model-specification-1" class="section level3" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Model specification</h3>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="modeling.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Models:</span></span>
<span id="cb89-2"><a href="modeling.html#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="modeling.html#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Random forest model for comparison</span></span>
<span id="cb89-4"><a href="modeling.html#cb89-4" aria-hidden="true" tabindex="-1"></a>ins_rf_model <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-5"><a href="modeling.html#cb89-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mtry =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb89-6"><a href="modeling.html#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;ranger&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb89-7"><a href="modeling.html#cb89-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span>
<span id="cb89-8"><a href="modeling.html#cb89-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-9"><a href="modeling.html#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="co"># XGBoost model</span></span>
<span id="cb89-10"><a href="modeling.html#cb89-10" aria-hidden="true" tabindex="-1"></a>ins_boost_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-11"><a href="modeling.html#cb89-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-12"><a href="modeling.html#cb89-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-13"><a href="modeling.html#cb89-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-14"><a href="modeling.html#cb89-14" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-15"><a href="modeling.html#cb89-15" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample_size =</span> <span class="fu">tune</span>(),</span>
<span id="cb89-16"><a href="modeling.html#cb89-16" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stop_iter =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-17"><a href="modeling.html#cb89-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb89-18"><a href="modeling.html#cb89-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="modeling.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Workflows: model + recipe</span></span>
<span id="cb90-2"><a href="modeling.html#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="modeling.html#cb90-3" aria-hidden="true" tabindex="-1"></a>ins_rf_wflow <span class="ot">&lt;-</span></span>
<span id="cb90-4"><a href="modeling.html#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb90-5"><a href="modeling.html#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(ins_rf_model) <span class="sc">%&gt;%</span></span>
<span id="cb90-6"><a href="modeling.html#cb90-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ins_rec_rf)</span>
<span id="cb90-7"><a href="modeling.html#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="modeling.html#cb90-8" aria-hidden="true" tabindex="-1"></a>ins_boost_wflow <span class="ot">&lt;-</span></span>
<span id="cb90-9"><a href="modeling.html#cb90-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb90-10"><a href="modeling.html#cb90-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(ins_boost_model) <span class="sc">%&gt;%</span></span>
<span id="cb90-11"><a href="modeling.html#cb90-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ins_rec_boost)</span></code></pre></div>
</div>
<div id="tuning-1" class="section level3" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Tuning</h3>
<p>For the hyperparameter tuning one needs validation sets to monitor the models on unseen data. To do this 5-fold cross validation (CV) is used here.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="modeling.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Resampling object</span></span>
<span id="cb91-2"><a href="modeling.html#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb91-3"><a href="modeling.html#cb91-3" aria-hidden="true" tabindex="-1"></a>ins_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ins_train, <span class="at">v =</span> <span class="dv">5</span>)</span></code></pre></div>
<p>Now the parameter objects will be fixed for the grid searches analogously to above.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="modeling.html#cb92-1" aria-hidden="true" tabindex="-1"></a>ins_rf_params <span class="ot">&lt;-</span> ins_rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb92-2"><a href="modeling.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>() <span class="sc">%&gt;%</span></span>
<span id="cb92-3"><a href="modeling.html#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">trees =</span> <span class="fu">trees</span>(<span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">2000</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb92-4"><a href="modeling.html#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(ins_train)</span>
<span id="cb92-5"><a href="modeling.html#cb92-5" aria-hidden="true" tabindex="-1"></a>ins_rf_params <span class="sc">%&gt;%</span> <span class="fu">pull_dials_object</span>(<span class="st">&quot;trees&quot;</span>)</span></code></pre></div>
<pre><code>## # Trees (quantitative)
## Range: [100, 2000]</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="modeling.html#cb94-1" aria-hidden="true" tabindex="-1"></a>ins_rf_params <span class="sc">%&gt;%</span> <span class="fu">pull_dials_object</span>(<span class="st">&quot;mtry&quot;</span>)</span></code></pre></div>
<pre><code>## # Randomly Selected Predictors (quantitative)
## Range: [1, 8]</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="modeling.html#cb96-1" aria-hidden="true" tabindex="-1"></a>ins_boost_params <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb96-2"><a href="modeling.html#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>() <span class="sc">%&gt;%</span></span>
<span id="cb96-3"><a href="modeling.html#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">trees =</span> <span class="fu">trees</span>(<span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">2000</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb96-4"><a href="modeling.html#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(ins_train)</span>
<span id="cb96-5"><a href="modeling.html#cb96-5" aria-hidden="true" tabindex="-1"></a>ins_boost_params</span></code></pre></div>
<pre><code>## Collection of 6 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[+]
##           trees          trees nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]</code></pre>
<p>The <strong>random forest model</strong> goes first with the tuning.</p>
<p>Here there are as seen above only two hyperparameters to be tuned thus 30 combinations should suffice.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="modeling.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 2 minutes</span></span>
<span id="cb98-2"><a href="modeling.html#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb98-3"><a href="modeling.html#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb98-4"><a href="modeling.html#cb98-4" aria-hidden="true" tabindex="-1"></a>  ins_rf_tune <span class="ot">&lt;-</span> ins_rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb98-5"><a href="modeling.html#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb98-6"><a href="modeling.html#cb98-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  ins_folds,</span>
<span id="cb98-7"><a href="modeling.html#cb98-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> ins_rf_params <span class="sc">%&gt;%</span></span>
<span id="cb98-8"><a href="modeling.html#cb98-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(<span class="at">size =</span> <span class="dv">30</span>, <span class="at">original =</span> <span class="cn">FALSE</span>),</span>
<span id="cb98-9"><a href="modeling.html#cb98-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb98-10"><a href="modeling.html#cb98-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-11"><a href="modeling.html#cb98-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb98-12"><a href="modeling.html#cb98-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-13"><a href="modeling.html#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="co"># visualization of the tuning results (snapshot of the output below)</span></span>
<span id="cb98-14"><a href="modeling.html#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ins_rf_tune) <span class="sc">+</span> <span class="fu">theme_light</span>()</span>
<span id="cb98-15"><a href="modeling.html#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co"># this functions shows the best combinations wrt the rmse metric of all the</span></span>
<span id="cb98-16"><a href="modeling.html#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="co"># combinations in the grid</span></span>
<span id="cb98-17"><a href="modeling.html#cb98-17" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_rf_tune, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:rfInstuneplot"></span>
<img src="_pictures/rf_ins_tune_plot.png" alt="Result of a spacefilling grid search for the random forest model." width="70%" />
<p class="caption">
Figure 5.4: Result of a spacefilling grid search for the random forest model.
</p>
</div>
<p>The visualization alongside the best performing results suggest that a value of <code>mtry</code>of 4 and 1000 <code>trees</code> should give good results. Thus one can finalize and fit this model.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="modeling.html#cb99-1" aria-hidden="true" tabindex="-1"></a>final_ins_rf_wflow <span class="ot">&lt;-</span> </span>
<span id="cb99-2"><a href="modeling.html#cb99-2" aria-hidden="true" tabindex="-1"></a>  ins_rf_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb99-3"><a href="modeling.html#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">tibble</span>(</span>
<span id="cb99-4"><a href="modeling.html#cb99-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="dv">1000</span>,</span>
<span id="cb99-5"><a href="modeling.html#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="dv">4</span></span>
<span id="cb99-6"><a href="modeling.html#cb99-6" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb99-7"><a href="modeling.html#cb99-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ins_train)</span></code></pre></div>
<p>Now the <strong>boosting model</strong>.</p>
<p>Again one starts to tune over the number of trees first (this time we also use three different tree depths to visualize the impact of this parameter too)</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="modeling.html#cb100-1" aria-hidden="true" tabindex="-1"></a>first_grid_boost_ins <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb100-2"><a href="modeling.html#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">250</span>, <span class="dv">2000</span>, <span class="dv">250</span>),</span>
<span id="cb100-3"><a href="modeling.html#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">8</span>,</span>
<span id="cb100-4"><a href="modeling.html#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">6</span>),</span>
<span id="cb100-5"><a href="modeling.html#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.000001</span>,</span>
<span id="cb100-6"><a href="modeling.html#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb100-7"><a href="modeling.html#cb100-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb100-8"><a href="modeling.html#cb100-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="modeling.html#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly half a minute</span></span>
<span id="cb101-2"><a href="modeling.html#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb101-3"><a href="modeling.html#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb101-4"><a href="modeling.html#cb101-4" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_first <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb101-5"><a href="modeling.html#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb101-6"><a href="modeling.html#cb101-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  ins_folds,</span>
<span id="cb101-7"><a href="modeling.html#cb101-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> first_grid_boost_ins,</span>
<span id="cb101-8"><a href="modeling.html#cb101-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb101-9"><a href="modeling.html#cb101-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb101-10"><a href="modeling.html#cb101-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb101-11"><a href="modeling.html#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="modeling.html#cb101-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-13"><a href="modeling.html#cb101-13" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_first)</span></code></pre></div>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="modeling.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the tuning results (output in the figure below)</span></span>
<span id="cb102-2"><a href="modeling.html#cb102-2" aria-hidden="true" tabindex="-1"></a>ins_boost_tune_first <span class="sc">%&gt;%</span></span>
<span id="cb102-3"><a href="modeling.html#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb102-4"><a href="modeling.html#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> trees, <span class="at">y =</span> mean, <span class="at">col =</span> <span class="fu">factor</span>(tree_depth))) <span class="sc">+</span></span>
<span id="cb102-5"><a href="modeling.html#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb102-6"><a href="modeling.html#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb102-7"><a href="modeling.html#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb102-8"><a href="modeling.html#cb102-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">col =</span> <span class="st">&quot;Max tree depth&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Number of trees&quot;</span>,</span>
<span id="cb102-9"><a href="modeling.html#cb102-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-10"><a href="modeling.html#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;C&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-11"><a href="modeling.html#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric) <span class="sc">+</span></span>
<span id="cb102-12"><a href="modeling.html#cb102-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:boostInstuneplot1"></span>
<img src="_pictures/boost_ins_tune_plot1.png" alt="Comparison of the initial grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates." width="70%" />
<p class="caption">
Figure 5.5: Comparison of the initial grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates.
</p>
</div>
<p>This visualization clearly shows that one has to have a closer look at the region around 500 trees. More than 500 trees might lead to overfitting as seen here.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="modeling.html#cb103-1" aria-hidden="true" tabindex="-1"></a>second_grid_boost_ins <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb103-2"><a href="modeling.html#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">250</span>, <span class="dv">750</span>, <span class="dv">50</span>),</span>
<span id="cb103-3"><a href="modeling.html#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">8</span>,</span>
<span id="cb103-4"><a href="modeling.html#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>),</span>
<span id="cb103-5"><a href="modeling.html#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.000001</span>,</span>
<span id="cb103-6"><a href="modeling.html#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.01</span>,</span>
<span id="cb103-7"><a href="modeling.html#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb103-8"><a href="modeling.html#cb103-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="modeling.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 15 seconds</span></span>
<span id="cb104-2"><a href="modeling.html#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb104-3"><a href="modeling.html#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb104-4"><a href="modeling.html#cb104-4" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_second <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb104-5"><a href="modeling.html#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb104-6"><a href="modeling.html#cb104-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  ins_folds,</span>
<span id="cb104-7"><a href="modeling.html#cb104-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> second_grid_boost_ins,</span>
<span id="cb104-8"><a href="modeling.html#cb104-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb104-9"><a href="modeling.html#cb104-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb104-10"><a href="modeling.html#cb104-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb104-11"><a href="modeling.html#cb104-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-12"><a href="modeling.html#cb104-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-13"><a href="modeling.html#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_second)</span></code></pre></div>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="modeling.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the tuning results (output in the figure below)</span></span>
<span id="cb105-2"><a href="modeling.html#cb105-2" aria-hidden="true" tabindex="-1"></a>ins_boost_tune_second <span class="sc">%&gt;%</span></span>
<span id="cb105-3"><a href="modeling.html#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb105-4"><a href="modeling.html#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> trees, <span class="at">y =</span> mean, <span class="at">col =</span> <span class="fu">factor</span>(tree_depth))) <span class="sc">+</span></span>
<span id="cb105-5"><a href="modeling.html#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb105-6"><a href="modeling.html#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb105-7"><a href="modeling.html#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb105-8"><a href="modeling.html#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">col =</span> <span class="st">&quot;Max tree depth&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Number of trees&quot;</span>,</span>
<span id="cb105-9"><a href="modeling.html#cb105-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb105-10"><a href="modeling.html#cb105-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;C&quot;</span>) <span class="sc">+</span></span>
<span id="cb105-11"><a href="modeling.html#cb105-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric) <span class="sc">+</span></span>
<span id="cb105-12"><a href="modeling.html#cb105-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:boostInstuneplot2"></span>
<img src="_pictures/boost_ins_tune_plot2.png" alt="Comparison of the second grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates." width="70%" />
<p class="caption">
Figure 5.6: Comparison of the second grid search for the number of trees w.r.t. the maximum tree depth. Actually with tiny confidence bands around the estimates.
</p>
</div>
<p>So from this visualization one can conclude that a number of trees of 600 should suffice to get a decent model. So the workflow will be updated and the number of trees fixed. After that the first major space filling grid search will be performed. Moreover with the previous visualizations in mind one can reduce the bound of the parameter space of the maximum tree depth quite a bit from 15 to 9. A minimum tree depth of 2 seems also appropriate.
Before one does that mainly for a view on the influence of the learning rate one can tune one round only with the learning rate and some tree numbers for comparison.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="modeling.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tune mainly learn rate</span></span>
<span id="cb106-2"><a href="modeling.html#cb106-2" aria-hidden="true" tabindex="-1"></a>lrate_grid_boost_ins <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb106-3"><a href="modeling.html#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">seq</span>(<span class="dv">200</span>, <span class="dv">1500</span>, <span class="dv">100</span>),</span>
<span id="cb106-4"><a href="modeling.html#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="dv">8</span>,</span>
<span id="cb106-5"><a href="modeling.html#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">c</span>(<span class="dv">3</span>),</span>
<span id="cb106-6"><a href="modeling.html#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fu">c</span>(<span class="fl">0.000001</span>),</span>
<span id="cb106-7"><a href="modeling.html#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.01</span>, <span class="fl">0.001</span>, <span class="fl">0.0001</span>),</span>
<span id="cb106-8"><a href="modeling.html#cb106-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="dv">1</span></span>
<span id="cb106-9"><a href="modeling.html#cb106-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="modeling.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 20 seconds</span></span>
<span id="cb107-2"><a href="modeling.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb107-3"><a href="modeling.html#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb107-4"><a href="modeling.html#cb107-4" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_lrate <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb107-5"><a href="modeling.html#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb107-6"><a href="modeling.html#cb107-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span>  ins_folds,</span>
<span id="cb107-7"><a href="modeling.html#cb107-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> lrate_grid_boost_ins,</span>
<span id="cb107-8"><a href="modeling.html#cb107-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb107-9"><a href="modeling.html#cb107-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb107-10"><a href="modeling.html#cb107-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb107-11"><a href="modeling.html#cb107-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-12"><a href="modeling.html#cb107-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-13"><a href="modeling.html#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_lrate)</span></code></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="modeling.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the tuning results (output in the figure below)</span></span>
<span id="cb108-2"><a href="modeling.html#cb108-2" aria-hidden="true" tabindex="-1"></a>ins_boost_tune_lrate <span class="sc">%&gt;%</span></span>
<span id="cb108-3"><a href="modeling.html#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb108-4"><a href="modeling.html#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> trees, <span class="at">y =</span> mean, <span class="at">col =</span> <span class="fu">factor</span>(learn_rate))) <span class="sc">+</span></span>
<span id="cb108-5"><a href="modeling.html#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb108-6"><a href="modeling.html#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb108-7"><a href="modeling.html#cb108-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb108-8"><a href="modeling.html#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Number of trees&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">col =</span> <span class="st">&quot;Learning rate&quot;</span>,</span>
<span id="cb108-9"><a href="modeling.html#cb108-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb108-10"><a href="modeling.html#cb108-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;C&quot;</span>) <span class="sc">+</span></span>
<span id="cb108-11"><a href="modeling.html#cb108-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric) <span class="sc">+</span></span>
<span id="cb108-12"><a href="modeling.html#cb108-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:boostInstuneplotlrate"></span>
<img src="_pictures/boost_ins_tune_lrate.png" alt="Comparison of the grid search for the number of trees w.r.t. the learning rate. Actually with tiny confidence bands around the estimates." width="70%" />
<p class="caption">
Figure 5.7: Comparison of the grid search for the number of trees w.r.t. the learning rate. Actually with tiny confidence bands around the estimates.
</p>
</div>
<p>Now fix the number of trees hyperparameter.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="modeling.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fix the number of trees by redefining the boostin model with a </span></span>
<span id="cb109-2"><a href="modeling.html#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed number of trees.</span></span>
<span id="cb109-3"><a href="modeling.html#cb109-3" aria-hidden="true" tabindex="-1"></a>ins_boost_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">600</span>,</span>
<span id="cb109-4"><a href="modeling.html#cb109-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb109-5"><a href="modeling.html#cb109-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb109-6"><a href="modeling.html#cb109-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb109-7"><a href="modeling.html#cb109-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb109-8"><a href="modeling.html#cb109-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample_size =</span> <span class="fu">tune</span>(),</span>
<span id="cb109-9"><a href="modeling.html#cb109-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">stop_iter =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb109-10"><a href="modeling.html#cb109-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb109-11"><a href="modeling.html#cb109-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>)</span>
<span id="cb109-12"><a href="modeling.html#cb109-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-13"><a href="modeling.html#cb109-13" aria-hidden="true" tabindex="-1"></a><span class="co"># update the workflow</span></span>
<span id="cb109-14"><a href="modeling.html#cb109-14" aria-hidden="true" tabindex="-1"></a>ins_boost_wflow <span class="ot">&lt;-</span></span>
<span id="cb109-15"><a href="modeling.html#cb109-15" aria-hidden="true" tabindex="-1"></a>  ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb109-16"><a href="modeling.html#cb109-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(ins_boost_model)</span>
<span id="cb109-17"><a href="modeling.html#cb109-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-18"><a href="modeling.html#cb109-18" aria-hidden="true" tabindex="-1"></a>ins_boost_params <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb109-19"><a href="modeling.html#cb109-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parameters</span>() <span class="sc">%&gt;%</span></span>
<span id="cb109-20"><a href="modeling.html#cb109-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">tree_depth =</span> <span class="fu">tree_depth</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">9</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb109-21"><a href="modeling.html#cb109-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(ins_train)</span>
<span id="cb109-22"><a href="modeling.html#cb109-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-23"><a href="modeling.html#cb109-23" aria-hidden="true" tabindex="-1"></a><span class="co"># reduced hyperparameter space</span></span>
<span id="cb109-24"><a href="modeling.html#cb109-24" aria-hidden="true" tabindex="-1"></a>ins_boost_params</span></code></pre></div>
<pre><code>## Collection of 5 parameters for tuning
## 
##      identifier           type    object
##            mtry           mtry nparam[+]
##      tree_depth     tree_depth nparam[+]
##      learn_rate     learn_rate nparam[+]
##  loss_reduction loss_reduction nparam[+]
##     sample_size    sample_size nparam[+]</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="modeling.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now tune all the remaining hyperparameters with a large space filling grid</span></span>
<span id="cb111-2"><a href="modeling.html#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="modeling.html#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 10 minutes</span></span>
<span id="cb111-4"><a href="modeling.html#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb111-5"><a href="modeling.html#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb111-6"><a href="modeling.html#cb111-6" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_major1 <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb111-7"><a href="modeling.html#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb111-8"><a href="modeling.html#cb111-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> ins_folds,</span>
<span id="cb111-9"><a href="modeling.html#cb111-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> ins_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb111-10"><a href="modeling.html#cb111-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb111-11"><a href="modeling.html#cb111-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">300</span>),</span>
<span id="cb111-12"><a href="modeling.html#cb111-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb111-13"><a href="modeling.html#cb111-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb111-14"><a href="modeling.html#cb111-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb111-15"><a href="modeling.html#cb111-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-16"><a href="modeling.html#cb111-16" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_major1, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<p>Now again with a slightly refined grid.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="modeling.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now tune all the remaining hyperparameters with a refined space filling grid</span></span>
<span id="cb112-2"><a href="modeling.html#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="modeling.html#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co"># took roughly 15 minutes</span></span>
<span id="cb112-4"><a href="modeling.html#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb112-5"><a href="modeling.html#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb112-6"><a href="modeling.html#cb112-6" aria-hidden="true" tabindex="-1"></a>  ins_boost_tune_major2 <span class="ot">&lt;-</span> ins_boost_wflow <span class="sc">%&gt;%</span></span>
<span id="cb112-7"><a href="modeling.html#cb112-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tune_grid</span>(</span>
<span id="cb112-8"><a href="modeling.html#cb112-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> ins_folds,</span>
<span id="cb112-9"><a href="modeling.html#cb112-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">grid =</span> ins_boost_params <span class="sc">%&gt;%</span></span>
<span id="cb112-10"><a href="modeling.html#cb112-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">update</span>(</span>
<span id="cb112-11"><a href="modeling.html#cb112-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">mtry =</span> <span class="fu">mtry</span>(<span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">8</span>)),</span>
<span id="cb112-12"><a href="modeling.html#cb112-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">tree_depth =</span> <span class="fu">tree_depth</span>(<span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>)),</span>
<span id="cb112-13"><a href="modeling.html#cb112-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">learn_rate =</span> <span class="fu">learn_rate</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.7</span>, <span class="sc">-</span><span class="fl">1.5</span>)),</span>
<span id="cb112-14"><a href="modeling.html#cb112-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">loss_reduction =</span> <span class="fu">loss_reduction</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="sc">-</span><span class="fl">1.5</span>)),</span>
<span id="cb112-15"><a href="modeling.html#cb112-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">sample_size =</span> <span class="fu">sample_prop</span>(<span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.9</span>))</span>
<span id="cb112-16"><a href="modeling.html#cb112-16" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb112-17"><a href="modeling.html#cb112-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb112-18"><a href="modeling.html#cb112-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">300</span>),</span>
<span id="cb112-19"><a href="modeling.html#cb112-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> regr_metrics</span>
<span id="cb112-20"><a href="modeling.html#cb112-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb112-21"><a href="modeling.html#cb112-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb112-22"><a href="modeling.html#cb112-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-23"><a href="modeling.html#cb112-23" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(ins_boost_tune_major2, <span class="at">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<p>The results here are quite clear. One will further use a <code>mtry</code> value of 7, a <code>tree_depth</code> of 3, a <code>learn_rate</code> of 0.02, a <code>loss_reduction</code> of 0.03 and a <code>sample_size</code> of 0.8.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="modeling.html#cb113-1" aria-hidden="true" tabindex="-1"></a>final_ins_boost_wflow <span class="ot">&lt;-</span> </span>
<span id="cb113-2"><a href="modeling.html#cb113-2" aria-hidden="true" tabindex="-1"></a>  ins_boost_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb113-3"><a href="modeling.html#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">tibble</span>(</span>
<span id="cb113-4"><a href="modeling.html#cb113-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="dv">7</span>,</span>
<span id="cb113-5"><a href="modeling.html#cb113-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="dv">3</span>,</span>
<span id="cb113-6"><a href="modeling.html#cb113-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> <span class="fl">0.02</span>,</span>
<span id="cb113-7"><a href="modeling.html#cb113-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">loss_reduction =</span> <span class="fl">0.03</span>,</span>
<span id="cb113-8"><a href="modeling.html#cb113-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_size =</span> <span class="fl">0.8</span></span>
<span id="cb113-9"><a href="modeling.html#cb113-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb113-10"><a href="modeling.html#cb113-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ins_train)</span></code></pre></div>
<p>From here one no computational intensive task will be performed so one stops the cluster.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="modeling.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stop cluster</span></span>
<span id="cb114-2"><a href="modeling.html#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code></pre></div>
</div>
<div id="evaluate-and-understand-the-model-1" class="section level3" number="5.2.4">
<h3><span class="header-section-number">5.2.4</span> Evaluate and understand the model</h3>
<p>First a visualization of the variable importance. The variable importance is calculated by measuring the frequency of appearance of each feature in the single trees.</p>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-205-1.png" width="672" />
Here one can clearly see that the trends that were observable during the EDA are refelcted here again. The most influential variable is indeed the smoker variable, closely followed by the age variable. Also the bmi and the number of children seem to be relevant.</p>
<p>Now the really interesting part is which model performed the best on the test data set. The results can be viewed below in tabular and grapical form.</p>
<table>
<caption><span id="tab:perfIns">Table 5.2: </span>Performance on the test data</caption>
<thead>
<tr class="header">
<th align="left">model</th>
<th align="right">mae</th>
<th align="right">rmse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">boost_pred</td>
<td align="right">0.0820</td>
<td align="right">0.1678</td>
</tr>
<tr class="even">
<td align="left">rf_pred</td>
<td align="right">0.0834</td>
<td align="right">0.1766</td>
</tr>
<tr class="odd">
<td align="left">baseline_lm</td>
<td align="right">0.1055</td>
<td align="right">0.1795</td>
</tr>
<tr class="even">
<td align="left">intercept_pred</td>
<td align="right">0.3189</td>
<td align="right">0.3922</td>
</tr>
</tbody>
</table>
<p><img src="boosting_methods_files/figure-html/unnamed-chunk-206-1.png" width="672" /></p>
<p>Some interpretation here.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="eda.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="conclusion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["boosting_methods.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
